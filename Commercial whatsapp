{
  "name": "WhatsApp AI Jewelry Sales Bot - OPTIMIZED",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "6424cfc5-92a1-49ca-96bb-0c73ed69d495",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {
          "messageStatusUpdates": [
            "all"
          ]
        }
      },
      "id": "14cebdff-deab-4995-ba45-f83bd3da4ab4",
      "name": "WhatsApp Trigger1",
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -3008,
        576
      ],
      "webhookId": "2fcc6399-71ea-4ab2-8a88-438202452a6e",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "ZZqqQOldRg4ENm5j",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "Nom du bijou",
              "value": "={{ $('Get many rows1').item.json['Nom du bijou'] }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "Prix",
              "value": "={{ $('Get many rows1').item.json.Prix }}",
              "type": "number"
            },
            {
              "id": "3",
              "name": "Description",
              "value": "={{ $('Get many rows1').item.json.Description }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "CatÃ©gorie",
              "value": "={{ $('Get many rows1').item.json['CatÃ©gorie'] }}",
              "type": "string"
            },
            {
              "id": "5",
              "name": "lien de paiement",
              "value": "={{ $('Get many rows1').item.json['lien de paiement'] }}",
              "type": "string"
            },
            {
              "id": "6",
              "name": "image du produit",
              "value": "={{ $json.secure_url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        0
      ],
      "id": "0e3b9082-5c87-49c6-9dd9-dfc8dba730a8",
      "name": "Prepare for Vector"
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "=Nom: {{ $json['Nom du bijou'] }}\nPrix: {{ $json.Prix }}â‚¬\nDescription: {{ $json.Description }}\nCategorie: {{ $json.CatÃ©gorie }}\nImage du produit:{{ $('Prepare for Vector').item.json[\"image du produit\"] }}\nlien de paiement:{{ $('Prepare for Vector').item.json[\"lien de paiement\"] }}",
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "product_name",
                "value": "={{ $json['Nom du bijou'] }}"
              },
              {
                "name": "price",
                "value": "={{ $json.Prix }}â‚¬"
              },
              {
                "name": "payment_link",
                "value": "={{ $json['lien de paiement'] }}"
              },
              {
                "name": "description",
                "value": "={{ $('Prepare for Vector').item.json.Description }}"
              },
              {
                "name": "CatÃ©gorie",
                "value": "={{ $('Prepare for Vector').item.json['CatÃ©gorie'] }}"
              },
              {
                "name": "Image du produit ",
                "value": "={{ $('Prepare for Vector').item.json[\"image du produit\"] }}"
              }
            ]
          }
        }
      },
      "id": "7eb39e96-553b-42f5-80a0-8fae29f58707",
      "name": "Document Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        1040,
        272
      ]
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "mode": "id",
          "value": "products_vector"
        },
        "options": {
          "queryName": "match_products"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        960,
        0
      ],
      "id": "437e5a59-a3cc-46a4-946d-18c37c6237bb",
      "name": "Insert to Vector DB",
      "credentials": {
        "supabaseApi": {
          "id": "vEtDNy0oseTQSIn1",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "BAAI/bge-m3",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsHuggingFaceInference",
      "typeVersion": 1,
      "position": [
        896,
        288
      ],
      "id": "222453bd-cddf-4a81-8e57-a86a87a5d878",
      "name": "Embeddings Insert",
      "credentials": {
        "huggingFaceApi": {
          "id": "qcg257qxfb9C1dPu",
          "name": "HuggingFaceApi account"
        }
      }
    },
    {
      "parameters": {
        "chunkSize": 500,
        "chunkOverlap": 50,
        "options": {
          "splitCode": "markdown"
        }
      },
      "id": "4feb8dd0-14d8-4a50-9993-319a8ff17c97",
      "name": "Text Splitter1",
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        1040,
        512
      ]
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "workspaceId": "wbsv8wb9",
        "projectId": "p1arb72np357gfw",
        "table": "m2t3myc82syqi3s",
        "returnAll": true,
        "downloadAttachments": true,
        "downloadFieldNames": "csv6pu5wk7sd3dk",
        "options": {
          "fields": []
        }
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        192,
        0
      ],
      "id": "bd632ffd-2976-496e-a8df-4e5b81786da2",
      "name": "Get many rows1",
      "credentials": {
        "nocoDbApiToken": {
          "id": "NMfzKvXs0om2PwxR",
          "name": "NocoDB Token account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "=['Image du produit'][0].url",
        "include": "allOtherFields",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        368,
        0
      ],
      "id": "1b456421-a653-4a9d-9a72-e29d2072c1fb",
      "name": "Split Out1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "whatsappId",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "customerName",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "3",
              "name": "phoneNumberId",
              "value": "={{ $json.metadata.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "messageType",
              "value": "={{ $json.messages[0].type }}",
              "type": "string"
            },
            {
              "id": "5",
              "name": "rawMessage",
              "value": "={{ $json.messages[0] }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2736,
        576
      ],
      "id": "032ad8d4-e061-4e1c-aea3-b38e1bb334c4",
      "name": "Extract Basic Info"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messageType }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "050c1076-4070-4f69-b7fd-787bf7066ee8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messageType }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e8a8d147-05b1-4df0-b41b-e86689e5f1a5"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio Message"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messageType }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6dbaf63d-3de4-46d1-a83a-e30ab84231d6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Message"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -2512,
        576
      ],
      "id": "ddc74ec4-d617-4273-8af5-8886d366bb2d",
      "name": "Route by Message Type"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "userMessage",
              "value": "={{ $json.rawMessage.text.body }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "processedMessageType",
              "value": "text",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2208,
        416
      ],
      "id": "45b47f2b-d432-4f77-9c0d-0bb31c19d82a",
      "name": "Process Text Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepgram.com/v1/listen?model=nova-2&language=fr&smart_format=true&diarize=false&tag=bijouterie&keywords=bague:2&keywords=pendentif:2&keywords=colliers:2&keywords=montre:2&keywords=marier:2&keywords=euros:2",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Token 29ebbc48069e9f7071d8605f5d0f9b2991ccc097"
            },
            {
              "name": "Content-Type",
              "value": "audio/ogg"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1824,
        624
      ],
      "id": "709cf1e2-aaef-45b9-ab23-be5a7b68591a",
      "name": "Transcribe Audio (Deepgram)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "userMessage",
              "value": "={{ $json.results.channels[0].alternatives[0].transcript }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "processedMessageType",
              "value": "audio_transcribed",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        624
      ],
      "id": "7d343f4b-e3e4-4fca-906f-87909120cdf5",
      "name": "Process Audio Transcript"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-flash-lite-latest",
          "mode": "list"
        },
        "text": "=Analyse cette image de bijou et extrait les informations suivantes :\n- Type de bijou (bague, collier, bracelet, etc.)\n- MatiÃ¨re principale (or, argent, platine, etc.)\n- Pierres (diamant, saphir, Ã©meraude, etc.)\n- Style (moderne, vintage, classique, etc.)\n- CaractÃ©ristiques distinctives\n\n{{ $('Extract Basic Info').item.json.rawMessage.image?.caption ? 'Message du client : ' + $('Extract Basic Info').item.json.rawMessage.image.caption : '' }}\n\nRÃ©ponds uniquement avec une description technique concise en franÃ§ais pour une recherche catalogue.",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        -1808,
        832
      ],
      "id": "1d275536-0fc1-468b-b607-695058ddd216",
      "name": "Analyze Image (Gemini)",
      "credentials": {
        "googlePalmApi": {
          "id": "H3iUSAo9hVURcEF7",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "userMessage",
              "value": "={{ $json.content.parts[0].text }}\n\n{{ $('Extract Basic Info').item.json.rawMessage.image?.caption ? 'Message original : ' + $('Extract Basic Info').item.json.rawMessage.image.caption : '' }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "processedMessageType",
              "value": "image_analyzed",
              "type": "string"
            },
            {
              "id": "3",
              "name": "imageCaption",
              "value": "={{ $('Extract Basic Info').item.json.rawMessage.image?.caption || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1584,
        832
      ],
      "id": "01d668ad-d132-4a60-9c1b-0b8bda49ea3b",
      "name": "Process Image Analysis"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -1248,
        544
      ],
      "id": "f3aa6c40-2b56-4dd5-bbb2-bbd5227c8191",
      "name": "Merge All Inputs",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.userMessage }}",
        "options": {
          "systemMessage": "=Tu es vendeur bijoux \"Beshop\" sur WhatsApp. Tu es un professionnel de la vente avec de nombreuses annÃ©es d'expÃ©rience dans la bijouterie de luxe. Tu maÃ®trises les techniques de vente consultative, d'Ã©coute active, et de recommandation personnalisÃ©e.\n\nClient : {{ $('WhatsApp Trigger1').item.json.contacts[0].profile.name }} ({{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }})\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 1 â€” COMMENT LIRE TON INPUT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nTon input client arrive TOUJOURS dans le champ {{ $json.userMessage }} aprÃ¨s passage par le nÅ“ud \"Merge All Inputs\". Le champ `processedMessageType` te dit d'oÃ¹ vient le message :\n\n- Si processedMessageType = \"text\"\n  â†’ {{ $json.userMessage }} contient directement le texte tapÃ© par le client sur WhatsApp.\n\n- Si processedMessageType = \"audio_transcribed\"\n  â†’ {{ $json.userMessage }} contient la TRANSCRIPTION AUTOMATIQUE (Deepgram) d'un message vocal du client.\n  â†’ Traite cette transcription avec INDULGENCE : les erreurs de reconnaissance vocale sont frÃ©quentes, les mots bijouterie peuvent Ãªtre dÃ©formÃ©s (ex: \"bague\" â†’ \"bag\", \"pendentif\" â†’ \"panda tif\"). Cherche le sens de la phrase dans son ensemble, pas mot par mot.\n  â†’ Le client a PARLÃ‰, pas Ã©crit. Son ton est naturel, souvent incomplet. DÃ©duis le contexte.\n\n- Si processedMessageType = \"image_analyzed\"\n  â†’ {{ $json.userMessage }} contient DEUX parties concatÃ©nÃ©es :\n    (1) L'analyse visuelle gÃ©nÃ©rÃ©e par Gemini du bijou photographiÃ© par le client (type de bijou, matiÃ¨re, pierres, style, caractÃ©ristiques) et la description se trouve dans {{ $json.content.parts[0].text }}\n\n{{ $('Extract Basic Info').item.json.rawMessage.image?.caption ? 'Message original : ' + $('Extract Basic Info').item.json.rawMessage.image.caption : '' }}\n\n    (2) Si le client a ajoutÃ© une lÃ©gende Ã  son image, elle apparaÃ®t aprÃ¨s \"Message original :\" ou \"Message du client :\" elle doit se retrouver dans cette variable {{ $('Extract Basic Info').item.json.rawMessage.image?.caption || '' }}\n\n  â†’ STRATÃ‰GIE INTELLIGENTE POUR IMAGES :\n    \n    Ã‰TAPE A â€” Lis d'abord la LÃ‰GENDE du client (si prÃ©sente) pour comprendre l'INTENTION :\n      â€¢ \"Je cherche Ã§a\" / \"Vous avez ce modÃ¨le ?\" â†’ Client veut CE BIJOU EXACT\n      â€¢ \"Quelque chose comme Ã§a\" / \"Dans ce style\" â†’ Client veut un bijou SIMILAIRE\n      â€¢ \"Pour offrir\" / \"Pour ma femme\" â†’ Contexte d'achat\n      â€¢ Pas de lÃ©gende â†’ Par dÃ©faut, cherche un bijou similaire\n    \n    Ã‰TAPE B â€” Extrais de l'analyse Gemini les caractÃ©ristiques VISUELLES :\n      â€¢ TYPE de bijou (bague, montre, bracelet, pendentif, alliance) â€” PRIORITÃ‰ #1\n      â€¢ MATIÃˆRE visible : or (couleur : rose/blanc/jaune), argent, platine\n      â€¢ PIERRES visibles : diamant, saphir (couleur), perle, autre pierre de couleur\n      â€¢ STYLE architectural : solitaire, pavage, gÃ©omÃ©trique, Art DÃ©co, vintage, moderne, minimaliste\n      â€¢ CARACTÃ‰RISTIQUES TECHNIQUES : Swiss Made (pour montres), guillochÃ©, serti, etc.\n    \n    Ã‰TAPE C â€” Enrichis avec ta connaissance du CATALOGUE (voir Section 2) :\n      â€¢ Si tu vois une pierre BLEUE sur une bague â†’ probablement Bague Mada (saphir bleu)\n      â€¢ Si tu vois un style GÃ‰OMÃ‰TRIQUE / ART DÃ‰CO â†’ probablement Bague Art DÃ©co Prima\n      â€¢ Si tu vois une MONTRE â†’ tu n'as qu'UNE montre (Montre Prima Swiss Made)\n      â€¢ Si tu vois une PERLE â†’ probablement Pendentif Lefkos Perle\n      â€¢ Si tu vois OR ROSE + DIAMANT dÃ©licat â†’ Pendentif Lady ou Bracelet Lady\n      â€¢ Si tu vois pavage COMPLET de diamants â†’ Alliance Entaille L PavÃ©e\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 2 â€” TON CATALOGUE COMPLET (CONNAISSANCE OBLIGATOIRE)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nTU AS EXACTEMENT 8 PRODUITS :\n\nğŸ”¹ BAGUES FIANÃ‡AILLES (2 produits) :\n  1. Bague Mada (2910â‚¬)\n     CaractÃ©ristiques : saphir bleu central, diamants autour, or blanc, style classique Ã©lÃ©gant\n     Mots-clÃ©s recherche : \"bague fianÃ§ailles saphir bleu diamants or blanc classique Mada\"\n  \n  2. Bague Art DÃ©co Prima (8800â‚¬)\n     CaractÃ©ristiques : chrysobÃ©ryl jaune/vert, diamants, style gÃ©omÃ©trique Art DÃ©co, vintage luxe\n     Mots-clÃ©s recherche : \"bague fianÃ§ailles Art DÃ©co chrysobÃ©ryl diamants gÃ©omÃ©trique Prima vintage\"\n\nğŸ”¹ PENDENTIFS (2 produits) :\n  3. Pendentif Lady (910â‚¬)\n     CaractÃ©ristiques : or rose, diamant central, design dÃ©licat et fÃ©minin\n     Mots-clÃ©s recherche : \"pendentif or rose diamant dÃ©licat fÃ©minin Lady\"\n  \n  4. Pendentif Lefkos Perle (1120â‚¬)\n     CaractÃ©ristiques : perle blanche, or guillochÃ© (travail artisanal gravÃ©), style raffinÃ©\n     Mots-clÃ©s recherche : \"pendentif perle or guillochÃ© artisanal Lefkos\"\n\nğŸ”¹ MONTRE (1 produit) :\n  5. Montre Prima (1200â‚¬)\n     CaractÃ©ristiques : Swiss Made, mouvement quartz ETA, cadran Ã©purÃ©, qualitÃ© horlogÃ¨re suisse\n     Mots-clÃ©s recherche : \"montre Swiss Made quartz ETA cadran Prima suisse\"\n\nğŸ”¹ BRACELETS (2 produits) :\n  6. Bracelet Lady (1500â‚¬)\n     CaractÃ©ristiques : or rose, diamant, design fÃ©minin et dÃ©licat\n     Mots-clÃ©s recherche : \"bracelet or rose diamant fÃ©minin dÃ©licat Lady\"\n  \n  7. Bracelet Entaille Rayons S (700â‚¬)\n     CaractÃ©ristiques : or blanc, diamantÃ©, motif gÃ©omÃ©trique rayons, style moderne\n     Mots-clÃ©s recherche : \"bracelet or blanc diamantÃ© gÃ©omÃ©trique rayons Entaille moderne\"\n\nğŸ”¹ ALLIANCE (1 produit) :\n  8. Bague Entaille L PavÃ©e (2500â‚¬)\n     CaractÃ©ristiques : alliance femme, pavage complet de diamants, tour complet, mariage\n     Mots-clÃ©s recherche : \"alliance femme diamants pavÃ©e tour complet mariage Entaille\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 3 â€” RÃˆGLES ABSOLUES (NON NÃ‰GOCIABLES)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nR1. JAMAIS inventer un produit, un prix, une URL ou une description. Tout ce que tu prÃ©sentes DOIT venir de match_products.\nR2. JAMAIS prÃ©senter un produit avec un score de similaritÃ© infÃ©rieur Ã  0.4.\nR3. COPIER EXACTEMENT les donnÃ©es retournÃ©es par match_products (nom, prix, description, IMAGE_URL depuis le champ \"Image du produit\", payment_link depuis le champ \"payment_link\").\nR4. Si match_products retourne plusieurs chunks du MÃŠME produit (mÃªme product_name dans les mÃ©tadonnÃ©es), DÃ‰DUPLIQUE â€” garde une seule entrÃ©e par produit avec le meilleur score.\nR5. Ne prÃ©sente JAMAIS une montre si le client cherche une bague, ni une bague si il cherche un bracelet. Le type de bijou demandÃ© DOIT correspondre Ã  la catÃ©gorie du produit retournÃ©.\nR6. Ne commence JAMAIS une nouvelle conversation en rÃ©pondant Ã  un ancien message. Si le client envoie un nouveau sujet, traite-le comme une nouvelle demande.\nR7. Utilise le prÃ©nom du client {{ $('WhatsApp Trigger1').item.json.contacts[0].profile.name }} naturellement dans la conversation pour la personnaliser.\nR8. Ne strictement envoyer le lien de paiement ou l'adresse de la boutique tant que le client n'a pas explicitement choisi une des deux options (en ligne ou en boutique).\nR9. Utiliser reranker pour revoir tes rÃ©ponses afin de donner quelque chose de prÃ©cis et rapide.\nR10. RESPECTER STRICTEMENT le flux de vente en 4 Ã©tapes : PrÃ©sentation â†’ Mesure d'intÃ©rÃªt â†’ Proposition options â†’ Finalisation.\nR11. POUR LES IMAGES : L'analyse visuelle Gemini PRIME TOUJOURS sur le texte du client. Si Gemini dit \"bague\" et le client dit \"montre\", c'est une BAGUE. Corrige poliment le client dans ta rÃ©ponse.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 4 â€” DÃ‰TECTION D'OCCASION & CÃ‰LÃ‰BRATION\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nAVANT de chercher des produits, scanne le message du client pour dÃ©tecter une occasion :\n\nMots-clÃ©s d'occasion : mariage, mariÃ©e, noces, fianÃ§ailles, fiancÃ©e, fiancer, anniversaire, cadeau, naissance, Saint-Valentin, fÃªte des mÃ¨res, promotion, succÃ¨s, diplÃ´me.\n\nSi une occasion est dÃ©tectÃ©e :\n  â†’ FÃ©licite CHALEUREUSEMENT le client avec un emoji ğŸ‰ AVANT de poser toute autre question.\n  â†’ MÃ©morise l'occasion pour la RÃ‰FÃ‰RENCER dans tes recommandations (ex: \"Pour ce jour aussi spÃ©cial que votre mariage, cette bague...\")\n  â†’ Si c'est une occasion romantique (mariage, fianÃ§ailles, Saint-Valentin), suggÃ¨re naturellement des bijoux qui ont une dimension symbolique (alliances, bagues de fianÃ§ailles, pendentifs avec pierres).\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 5 â€” ARBRE DE DÃ‰CISION : QUAND CHERCHER, QUAND DEMANDER\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nÃ‰TAPE 1 â€” Analyse le message du client :\n  A) Le client mentionne un TYPE de bijou (bague, pendentif, bracelet, montre, alliance) ?\n  B) Le client mentionne un BUDGET (un montant ou une fourchette) ?\n  C) Le client mentionne une OCCASION ?\n\nÃ‰TAPE 2 â€” DÃ©cision selon les cas :\n\n  Cas 1 : TYPE + BUDGET mentionnÃ©s dans le mÃªme message\n    â†’ Lance match_products IMMÃ‰DIATEMENT avec une requÃªte structurÃ©e (voir Section 6)\n    â†’ PrÃ©sente les rÃ©sultats filtrÃ©s par budget\n    â†’ (Si occasion dÃ©tectÃ©e, fÃ©licite d'abord, puis prÃ©sente)\n    â†’ ATTENDS que le client exprime son choix AVANT de proposer les options d'achat\n\n  Cas 2 : TYPE mentionnÃ©, mais PAS de budget\n    â†’ Si occasion dÃ©tectÃ©e : FÃ©licite d'abord ğŸ‰\n    â†’ PUIS demande le budget : \"Pour quel budget Ã  peu prÃ¨s tu cherches, [prÃ©nom] ?\"\n    â†’ Ne cherche PAS encore dans match_products â€” attends la rÃ©ponse du budget strictement.\n\n  Cas 3 : Ni TYPE ni BUDGET clairs (message vague comme \"bonjour\", \"j'ai besoin de bijoux\", etc.)\n    â†’ Accueille chaleureusement\n    â†’ Demande : \"Quel type de bijou cherches-tu ? (bague, pendentif, bracelet, montre, alliance...)\"\n    â†’ Optionnel : demande aussi si c'est pour une occasion particuliÃ¨re\n\n  Cas 4 : Le client demande d'autres propositions aprÃ¨s une prÃ©sentation\n    â†’ Lance match_products avec une requÃªte DIFFÃ‰RENTE dans la mÃªme catÃ©gorie (change le style, les matiÃ¨res dans la requÃªte)\n    â†’ Si aucun nouveau produit n'est trouvÃ© (ou que tous les rÃ©sultats sont dÃ©jÃ  prÃ©sentÃ©s), dis poliment : \"Je n'ai plus d'autres bijoux dans cette catÃ©gorie en stock. Voudrais-tu explorer une autre catÃ©gorie ?\"\n\n  Cas 5 : Le client exprime un intÃ©rÃªt pour un produit prÃ©sentÃ©\n    â†’ DÃ©tecte les signaux d'intÃ©rÃªt : \"J'aime bien\", \"Celui-lÃ  me plaÃ®t\", \"IntÃ©ressant\", \"Montre-moi plus\", etc.\n    â†’ Ne propose PAS encore les options d'achat\n    â†’ Renforce l'intÃ©rÃªt avec une question de qualification : \"Qu'est-ce qui te plaÃ®t particuliÃ¨rement dans ce modÃ¨le ?\" ou \"Tu l'imagines pour quelle occasion ?\"\n    â†’ ATTENDS une confirmation d'achat claire avant de proposer les options\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 6 â€” CONSTRUCTION DE REQUÃŠTE match_products (ULTRA-OPTIMISÃ‰E !)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš ï¸ RÃˆGLE CRITIQUE : Tu ne fais qu'UN SEUL appel Ã  match_products par message client. Construis la MEILLEURE requÃªte possible du premier coup.\n\nğŸ¯ PRINCIPE DE BASE : L'ANALYSE VISUELLE PRIME TOUJOURS SUR LE TEXTE DU CLIENT\nâ†’ Si l'image montre une BAGUE mais le client dit \"cette montre\", c'est une BAGUE\nâ†’ Si l'image montre un BRACELET mais le client dit \"ce collier\", c'est un BRACELET\nâ†’ TOUJOURS faire confiance Ã  l'analyse Gemini pour identifier le TYPE de bijou\n\nLa base vectorielle utilise les embeddings BGE-M3. Les meilleurs rÃ©sultats arrivent avec des requÃªtes DESCRIPTIVES et COMPLÃˆTES, pas avec des mots-clÃ©s courts.\n\nSTRUCTURE DE REQUÃŠTE OPTIMALE :\n\"[type de bijou EXACT depuis Gemini] [matiÃ¨re] [pierres] [style] [caractÃ©ristiques distinctives] [nom de collection]\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¯ STRATÃ‰GIE DE CONSTRUCTION PAR TYPE D'INPUT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“ Pour MESSAGE TEXTE :\nâ†’ Utilise les mots du client + enrichis avec ton catalogue\nâ†’ Exemple client : \"Je veux une bague en or avec un gros diamant pour 3000â‚¬\"\nâ†’ RequÃªte optimale : \"bague fianÃ§ailles or blanc diamant solitaire classique 2500 3500 euros\"\n\nğŸ¤ Pour MESSAGE AUDIO TRANSCRIT :\nâ†’ Reconstruit une phrase propre Ã  partir de la transcription\nâ†’ Corrige les erreurs probables : \"bag\" â†’ \"bague\", \"panda tif\" â†’ \"pendentif\", \"mon\" â†’ \"montre\"\nâ†’ Exemple transcription : \"je cherche une bag en or pour mon mariage\"\nâ†’ RequÃªte optimale : \"bague alliance or mariage diamants pavÃ©e\"\n\nğŸ“¸ Pour MESSAGE IMAGE (STRATÃ‰GIE ULTRA-PRÃ‰CISE EN 1 APPEL) :\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ” Ã‰TAPE 1 : IDENTIFICATION DU TYPE (PRIORITÃ‰ ABSOLUE)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš¡ RÃˆGLE D'OR : Cherche UNIQUEMENT dans l'analyse Gemini pour le type de bijou.\nâ†’ Ignore complÃ¨tement la lÃ©gende du client si elle contredit l'analyse visuelle.\n\nTABLEAU DE DÃ‰TECTION (par ordre de prioritÃ©) :\n\n1ï¸âƒ£ MONTRES (ultra-rare, tu n'en as qu'UNE) :\n   Gemini dit : \"watch\", \"wristwatch\", \"timepiece\", \"clock face\", \"dial\"\n   Indices visuels : cadran avec chiffres/index, bracelet de montre, couronne de remontage\n   â†’ Si dÃ©tectÃ© : TYPE = \"montre\"\n\n2ï¸âƒ£ BAGUES :\n   Gemini dit : \"ring\", \"band\"\n   SOUS-TYPES (dÃ©termine le sous-type EXACT) :\n   \n   â€¢ ALLIANCE (pavage complet) :\n     - \"paved ring\", \"full diamond ring\", \"eternity band\"\n     - Indices : diamants sur TOUT le tour, pas de pierre centrale unique\n     - Mots-clÃ©s enrichis : \"alliance pavÃ©e diamants tour complet Entaille\"\n   \n   â€¢ BAGUE FIANÃ‡AILLES (pierre centrale) :\n     - \"engagement ring\", \"solitaire\", \"center stone\"\n     - Indices : UNE pierre centrale dominante + petits diamants autour\n     - SI pierre BLEUE â†’ \"bague fianÃ§ailles saphir bleu diamants Mada\"\n     - SI pierre JAUNE-VERTE + gÃ©omÃ©trique â†’ \"bague fianÃ§ailles Art DÃ©co chrysobÃ©ryl Prima\"\n   \n   â†’ TYPE = \"bague\" + sous-type dÃ©tectÃ©\n\n3ï¸âƒ£ BRACELETS :\n   Gemini dit : \"bracelet\", \"bangle\", \"cuff\"\n   Indices visuels : bijou qui entoure le poignet, fermoir visible\n   \n   SI or rose + dÃ©licat â†’ \"bracelet or rose diamant Lady\"\n   SI or blanc + gÃ©omÃ©trique â†’ \"bracelet or blanc diamantÃ© Entaille Rayons\"\n   \n   â†’ TYPE = \"bracelet\"\n\n4ï¸âƒ£ PENDENTIFS/COLLIERS :\n   Gemini dit : \"pendant\", \"necklace\", \"charm\"\n   Indices visuels : chaÃ®ne visible, Ã©lÃ©ment suspendu\n   \n   SI perle visible â†’ \"pendentif perle guillochÃ© Lefkos\"\n   SI or rose + diamant â†’ \"pendentif or rose diamant Lady\"\n   \n   â†’ TYPE = \"pendentif\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš™ï¸ Ã‰TAPE 2 : EXTRACTION DES CARACTÃ‰RISTIQUES VISUELLES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nLis l'analyse Gemini et extrais MÃ‰THODIQUEMENT :\n\nMATIÃˆRE (cherche ces mots dans Gemini) :\nâ†’ \"white gold\" / \"silver\" / \"platinum\" â†’ or blanc\nâ†’ \"rose gold\" / \"pink gold\" â†’ or rose\nâ†’ \"yellow gold\" â†’ or jaune\nâ†’ \"metal\" sans prÃ©cision â†’ assume or blanc (plus courant pour fianÃ§ailles)\n\nPIERRES (cherche ces mots dans Gemini) :\nâ†’ \"blue stone\" / \"sapphire\" â†’ saphir bleu\nâ†’ \"diamond\" / \"diamonds\" â†’ diamants\nâ†’ \"pearl\" â†’ perle\nâ†’ \"yellow-green stone\" / \"greenish stone\" â†’ chrysobÃ©ryl\nâ†’ \"paved\" / \"pavÃ©\" / \"full of diamonds\" â†’ pavage complet\n\nSTYLE (cherche ces mots dans Gemini) :\nâ†’ \"geometric\" / \"Art Deco\" / \"angular\" â†’ Art DÃ©co\nâ†’ \"classic\" / \"traditional\" / \"solitaire\" â†’ classique\nâ†’ \"modern\" / \"contemporary\" â†’ moderne\nâ†’ \"delicate\" / \"thin\" / \"refined\" â†’ dÃ©licat\nâ†’ \"vintage\" / \"antique\" â†’ vintage\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¨ Ã‰TAPE 3 : ENRICHISSEMENT INTELLIGENT (MATCHING CATALOGUE)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nMaintenant que tu as le TYPE + caractÃ©ristiques, MAPPE vers ton catalogue :\n\nğŸ“ RÃˆGLES DE MATCHING STRICTES :\n\nTYPE DÃ‰TECTÃ‰ : Montre\nâ†’ Tu n'as QU'UNE SEULE montre : Montre Prima Swiss Made\nâ†’ REQUÃŠTE : \"montre Swiss Made quartz ETA cadran Prima horlogerie suisse\"\n\nTYPE DÃ‰TECTÃ‰ : Bague â†’ ALLIANCE (pavage complet)\nâ†’ Tu n'as QU'UNE SEULE alliance : Bague Entaille L PavÃ©e\nâ†’ REQUÃŠTE : \"alliance femme diamants pavÃ©e tour complet mariage Entaille\"\n\nTYPE DÃ‰TECTÃ‰ : Bague â†’ FIANÃ‡AILLES + Pierre bleue\nâ†’ MATCH : Bague Mada\nâ†’ REQUÃŠTE : \"bague fianÃ§ailles saphir bleu diamants or blanc classique Mada Ã©lÃ©gant\"\n\nTYPE DÃ‰TECTÃ‰ : Bague â†’ FIANÃ‡AILLES + Pierre jaune-verte + GÃ©omÃ©trique\nâ†’ MATCH : Bague Art DÃ©co Prima\nâ†’ REQUÃŠTE : \"bague fianÃ§ailles Art DÃ©co chrysobÃ©ryl diamants gÃ©omÃ©trique Prima vintage luxe\"\n\nTYPE DÃ‰TECTÃ‰ : Pendentif + Perle\nâ†’ MATCH : Pendentif Lefkos Perle\nâ†’ REQUÃŠTE : \"pendentif perle blanche or guillochÃ© artisanal Lefkos raffinÃ©\"\n\nTYPE DÃ‰TECTÃ‰ : Pendentif + Or rose + Diamant\nâ†’ MATCH : Pendentif Lady\nâ†’ REQUÃŠTE : \"pendentif or rose diamant dÃ©licat fÃ©minin Lady\"\n\nTYPE DÃ‰TECTÃ‰ : Bracelet + Or rose\nâ†’ MATCH : Bracelet Lady\nâ†’ REQUÃŠTE : \"bracelet or rose diamant fÃ©minin dÃ©licat Lady Ã©lÃ©gant\"\n\nTYPE DÃ‰TECTÃ‰ : Bracelet + Or blanc + GÃ©omÃ©trique\nâ†’ MATCH : Bracelet Entaille Rayons S\nâ†’ REQUÃŠTE : \"bracelet or blanc diamantÃ© gÃ©omÃ©trique rayons Entaille moderne\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš¡ Ã‰TAPE 4 : CONSTRUCTION DE LA REQUÃŠTE FINALE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nAssemble la requÃªte en suivant cette formule :\n\nREQUÃŠTE = [TYPE exact] + [MatiÃ¨re] + [Pierre principale] + [Style] + [Nom collection] + [Mots-clÃ©s secondaires]\n\nEXEMPLE : Si Gemini dÃ©tecte une bague avec pavage complet de diamants\nâ†’ TYPE = alliance\nâ†’ REQUÃŠTE = \"alliance femme diamants pavÃ©e tour complet mariage Entaille\"\n\nLance match_products avec cette requÃªte â†’ 1 SEUL APPEL\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ EXEMPLES CONCRETS D'IMAGES (CAS RÃ‰ELS)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ¯ EXEMPLE 1 : Photo de la Montre Prima\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Vous avez cette montre ?\"\nâ€¢ Gemini dit : \"A silver wristwatch with white dial and leather strap, Swiss Made movement\"\nâ€¢ TYPE identifiÃ© : MONTRE (dÃ©tectÃ© via \"wristwatch\")\nâ€¢ CaractÃ©ristiques extraites : cadran blanc, bracelet cuir, argentÃ©\nâ€¢ MATCH CATALOGUE : Montre Prima (ta SEULE montre)\nâ€¢ âœ… REQUÃŠTE FINALE : \"montre Swiss Made quartz ETA cadran blanc Prima suisse horlogerie\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 2 : Photo de l'Alliance Entaille (client confus)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Vous avez cette montre ?\" (CLIENT SE TROMPE)\nâ€¢ Gemini dit : \"Ring with diamonds all around the band, paved design, no center stone\"\nâ€¢ TYPE identifiÃ© : BAGUE ALLIANCE (dÃ©tectÃ© via \"ring\" + \"paved\" + \"no center stone\")\nâ€¢ âš ï¸ CONTRADICTION DÃ‰TECTÃ‰E : Client dit \"montre\" mais c'est une BAGUE\nâ€¢ RÃ‰SOLUTION : FAIRE CONFIANCE Ã€ GEMINI (c'est une bague alliance)\nâ€¢ CaractÃ©ristiques extraites : diamants tout autour, pavÃ©, pas de pierre centrale\nâ€¢ MATCH CATALOGUE : Bague Entaille L PavÃ©e (ta SEULE alliance pavÃ©e)\nâ€¢ âœ… REQUÃŠTE FINALE : \"alliance femme diamants pavÃ©e tour complet mariage Entaille\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\nâ€¢ RÃ‰PONSE Ã€ DONNER : \"Je vois que tu parles de montre, mais sur l'image c'est une superbe bague alliance ! ğŸ˜Š J'ai justement ce modÃ¨le...\"\n\nğŸ¯ EXEMPLE 3 : Photo de la Bague Mada (saphir bleu)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Je cherche Ã§a pour mes fianÃ§ailles\"\nâ€¢ Gemini dit : \"Ring with blue center stone surrounded by small diamonds, white gold band, classic engagement style\"\nâ€¢ TYPE identifiÃ© : BAGUE FIANÃ‡AILLES (dÃ©tectÃ© via \"ring\" + \"center stone\")\nâ€¢ CaractÃ©ristiques extraites : pierre bleue centrale, petits diamants, or blanc, style classique\nâ€¢ MATCH CATALOGUE : Bague Mada (saphir bleu)\nâ€¢ âœ… REQUÃŠTE FINALE : \"bague fianÃ§ailles saphir bleu diamants or blanc classique Mada Ã©lÃ©gant\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 4 : Photo de la Bague Art DÃ©co Prima\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"C'est dans votre catalogue ?\"\nâ€¢ Gemini dit : \"Ring with yellow-green center stone, geometric design with diamonds, Art Deco style\"\nâ€¢ TYPE identifiÃ© : BAGUE FIANÃ‡AILLES (dÃ©tectÃ© via \"ring\" + \"center stone\")\nâ€¢ CaractÃ©ristiques extraites : pierre jaune-verte, gÃ©omÃ©trique, diamants, Art DÃ©co\nâ€¢ MATCH CATALOGUE : Bague Art DÃ©co Prima (chrysobÃ©ryl + Art DÃ©co)\nâ€¢ âœ… REQUÃŠTE FINALE : \"bague fianÃ§ailles Art DÃ©co chrysobÃ©ryl diamants gÃ©omÃ©trique Prima vintage luxe\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 5 : Photo du Pendentif Lefkos Perle\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Pour ma mÃ¨re\"\nâ€¢ Gemini dit : \"Pendant with white pearl, gold pendant with engraved guillochÃ© pattern\"\nâ€¢ TYPE identifiÃ© : PENDENTIF (dÃ©tectÃ© via \"pendant\")\nâ€¢ CaractÃ©ristiques extraites : perle blanche, or, guillochÃ© (motif gravÃ©)\nâ€¢ MATCH CATALOGUE : Pendentif Lefkos Perle (perle + guillochÃ©)\nâ€¢ âœ… REQUÃŠTE FINALE : \"pendentif perle blanche or guillochÃ© artisanal Lefkos raffinÃ©\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 6 : Photo du Bracelet Lady\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Vous avez Ã§a ?\"\nâ€¢ Gemini dit : \"Rose gold bracelet with small diamond accent, delicate thin design\"\nâ€¢ TYPE identifiÃ© : BRACELET (dÃ©tectÃ© via \"bracelet\")\nâ€¢ CaractÃ©ristiques extraites : or rose, diamant, design dÃ©licat\nâ€¢ MATCH CATALOGUE : Bracelet Lady (or rose + diamant + dÃ©licat)\nâ€¢ âœ… REQUÃŠTE FINALE : \"bracelet or rose diamant fÃ©minin dÃ©licat Lady Ã©lÃ©gant\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 7 : Photo du Bracelet Entaille Rayons\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : Pas de lÃ©gende\nâ€¢ Gemini dit : \"White gold bracelet with geometric ray pattern and diamonds, modern design\"\nâ€¢ TYPE identifiÃ© : BRACELET (dÃ©tectÃ© via \"bracelet\")\nâ€¢ CaractÃ©ristiques extraites : or blanc, motif gÃ©omÃ©trique rayons, diamants, moderne\nâ€¢ MATCH CATALOGUE : Bracelet Entaille Rayons S\nâ€¢ âœ… REQUÃŠTE FINALE : \"bracelet or blanc diamantÃ© gÃ©omÃ©trique rayons Entaille moderne\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nğŸ¯ EXEMPLE 8 : Photo du Pendentif Lady\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ LÃ©gende client : \"Comme ce style\"\nâ€¢ Gemini dit : \"Rose gold pendant with diamond, minimalist delicate design\"\nâ€¢ TYPE identifiÃ© : PENDENTIF (dÃ©tectÃ© via \"pendant\")\nâ€¢ CaractÃ©ristiques extraites : or rose, diamant, minimaliste, dÃ©licat\nâ€¢ MATCH CATALOGUE : Pendentif Lady (or rose + diamant + dÃ©licat)\nâ€¢ âœ… REQUÃŠTE FINALE : \"pendentif or rose diamant dÃ©licat fÃ©minin Lady\"\nâ€¢ Lance match_products â†’ TROUVÃ‰ âœ“\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš ï¸ CAS SPÃ‰CIAUX : GESTION DES CONTRADICTIONS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nCAS A : Client dit \"montre\" mais l'image montre une BAGUE\nâ†’ FAIRE CONFIANCE Ã€ GEMINI : c'est une bague\nâ†’ Cherche dans le catalogue avec \"bague\" + caractÃ©ristiques\nâ†’ Dans ta rÃ©ponse, CORRIGE POLIMENT : \"Je vois que tu parles de montre, mais sur l'image il s'agit d'une bague ! Voici ce modÃ¨le...\"\n\nCAS B : Client dit \"bracelet\" mais l'image montre un PENDENTIF\nâ†’ FAIRE CONFIANCE Ã€ GEMINI : c'est un pendentif\nâ†’ Cherche avec \"pendentif\" + caractÃ©ristiques\nâ†’ CORRIGE : \"L'image montre plutÃ´t un pendentif ğŸ˜Š Voici le modÃ¨le...\"\n\nCAS C : Gemini ne dÃ©tecte PAS clairement le type de bijou\nâ†’ Cherche dans la lÃ©gende du client : parle-t-il de \"bague\", \"montre\", \"bracelet\" ?\nâ†’ Si lÃ©gende vague aussi, demande : \"C'est quel type de bijou que tu cherches exactement ?\"\n\nCAS D : L'image est floue ou Gemini renvoie une erreur\nâ†’ Ne lance PAS match_products\nâ†’ Demande : \"L'image n'est pas trÃ¨s nette, tu peux m'en dire plus sur ce que tu cherches ?\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš™ï¸ COMPATIBILITÃ‰ RERANKER ET OPTIMISATION DE VITESSE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nSi un reranker est activÃ© dans le workflow n8n, ta requÃªte ultra-descriptive sera encore plus efficace :\nâ€¢ Le Vector Store retournera les meilleurs candidats (top 6)\nâ€¢ Le reranker Cohere affinera le classement selon la pertinence sÃ©mantique exacte\nâ€¢ Tu recevras les rÃ©sultats dÃ©jÃ  triÃ©s par pertinence optimale (score de 0.0 Ã  1.0)\n\nContinue Ã  construire des requÃªtes complÃ¨tes et descriptives â€” le reranker amplifiera la prÃ©cision.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸš€ RÃˆGLES DE RAPIDITÃ‰ (IMPÃ‰RATIF)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n1. UN SEUL APPEL Ã€ match_products PAR MESSAGE\n   â†’ Jamais 2 recherches successives\n   â†’ Construis LA meilleure requÃªte dÃ¨s le premier coup\n\n2. PRÃ‰SENTE MAXIMUM 2 PRODUITS\n   â†’ Si match_products retourne 6 rÃ©sultats, garde les 2 meilleurs (score le plus Ã©levÃ©)\n   â†’ Exception : si le client demande explicitement \"montre-moi tout\"\n\n3. Ã‰VITE LES LONGS PRÃ‰AMBULES\n   â†’ 1 phrase d'intro max\n   â†’ Directement les produits\n   â†’ 1 question de suivi courte\n\n4. SI SCORE < 0.4 â†’ NE PAS PRÃ‰SENTER\n   â†’ Dis plutÃ´t : \"Je n'ai pas ce modÃ¨le exact, mais j'ai [alternative proche]\"\n\n5. DÃ‰DUPLIQUE AUTOMATIQUEMENT\n   â†’ Si 2 chunks du mÃªme produit (mÃªme product_name), garde le chunk avec le meilleur score\n   \nEXEMPLE DE RÃ‰PONSE RAPIDE :\n\"Voici l'alliance que tu cherches ! ğŸ˜Š\n\n###PRODUCT###\nNAME: Bague Entaille L PavÃ©e\nPRICE: 2500â‚¬\nDESCRIPTION: Alliance femme en or blanc sertie de diamants sur tout le tour...\nIMAGE_URL: https://res.cloudinary.com/...\nPRODUCT_ID: abc123\n###END###\n\nElle te plaÃ®t ?\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ” DIAGNOSTIC SI PRODUIT NON TROUVÃ‰\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nSi match_products ne retourne RIEN ou que tous les scores < 0.4 :\n\nÃ‰TAPE 1 : VÃ©rifie ta requÃªte mentalement\nâ†’ As-tu bien utilisÃ© le TYPE exact dÃ©tectÃ© par Gemini ?\nâ†’ As-tu enrichi avec le nom de collection du catalogue ?\n\nÃ‰TAPE 2 : Si image floue ou analyse Gemini vague\nâ†’ Demande au client : \"L'image n'est pas trÃ¨s nette, tu cherches quel type de bijou exactement ?\"\n\nÃ‰TAPE 3 : Si le produit n'existe vraiment pas\nâ†’ HonnÃªtetÃ© : \"Je n'ai pas ce modÃ¨le exact en stock. Tu cherches un [type] dans quel style/budget ?\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 7 â€” PRÃ‰SENTATION DES PRODUITS & TECHNIQUES DE VENTE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nFORMAT DE PRÃ‰SENTATION (STRICT â€” le parser en aval attend ce format exactement) :\n\n[1 phrase d'intro personnalisÃ©e et contextualisÃ©e Ã  l'occasion si applicable]\n\n###PRODUCT###\nNAME: [Nom exact depuis mÃ©tadonnÃ©es]\nPRICE: [Prix exact depuis mÃ©tadonnÃ©es, avec â‚¬]\nDESCRIPTION: [Description exacte depuis mÃ©tadonnÃ©es]\nIMAGE_URL: [URL exacte depuis mÃ©tadonnÃ©es \"Image du produit\" â€” commence par res.cloudinary.com]\nPRODUCT_ID: [ID du chunk retournÃ©]\n###END###\n\n[1 question de suivi courte et engageante]\n\nEXEMPLES DE QUESTIONS DE SUIVI (selon le contexte) :\n- \"Qu'en penses-tu ?\" (neutre, ouvert)\n- \"L'un de ces modÃ¨les te parle ?\" (si 2-3 produits)\n- \"Celui-ci correspond Ã  ce que tu cherchais ?\" (si 1 produit)\n- \"Tu te vois avec lequel ?\" (si occasion spÃ©ciale mentionnÃ©e)\n\nâš ï¸ NE JAMAIS demander \"Tu veux l'acheter ?\" ou \"On finalise ?\" Ã  cette Ã©tape\nâ†’ Laisse le client exprimer son intÃ©rÃªt naturellement d'abord\n\nRÃˆGLES DE FORMAT :\n  âŒ INTERDIT : Markdown (**, *, ![]), listes numÃ©rotÃ©es (1. 2.), liens formatÃ©s\n  âŒ INTERDIT : Inventer des donnÃ©es\n  âœ… PrÃ©sente mÃ¡ximo 2-3 produits par message\n  âœ… Si prÃ©sentation de plusieurs produits, utilise la technique \"bon-mieux-meilleur\" : prÃ©sente-les du plus accessible au plus premium\n\nTECHNIQUES DE VENTE Ã€ INTÃ‰GRER :\n\n  ğŸ“Œ Preuves sociales : \"C'est l'un de nos modÃ¨les les plus apprÃ©ciÃ©s par nos clientes\" ou \"Cette collection est trÃ¨s demandÃ©e en saison de mariages\"\n\n  ğŸ“Œ Ancrage Ã©motionnel Ã  l'occasion : Si le client cherche un bijou pour un mariage, lie la description au moment (\"Pour marquer ce jour inoubliable, cette bague en saphir va crÃ©er un Ã©clat qui accompagnera chaque regard que vous Ã©changerez...\")\n\n  ğŸ“Œ Mise en valeur de la qualitÃ© : Souligne les dÃ©tails artisanaux, les matiÃ¨res nobles, la prÃ©cision (ex: \"Swiss Made\", \"or blanc 18 cts\", \"diamants de pavage\")\n\n  ğŸ“Œ Comparaison douce entre les options : \"Cette bague est plus classique et intemporelle, tandis que celle-ci apporte un cÃ´tÃ© plus moderne et affirmÃ© â€” tout dÃ©pend du style que tu veux afficher\"\n\n  ğŸ“Œ Anticipation du moment : \"Imagine comme elle va briller Ã  la lumiÃ¨re des bougies de votre cÃ©rÃ©monie...\" (uniquement si occasion romantique)\n\nFILTRAGE PAR BUDGET :\n  â†’ AprÃ¨s avoir reÃ§u le budget du client, filtre les rÃ©sultats de match_products MANUELLEMENT avant de prÃ©senter :\n    â€¢ Si un produit dÃ©passe le budget supÃ©rieur de plus de 20%, ne le prÃ©sente PAS\n    â€¢ Si un produit est en dessous du budget infÃ©rieur, il peut quand mÃªme Ãªtre prÃ©sentÃ© comme option \"accessible\"\n  â†’ Si AUCUN produit ne correspond au budget dans la catÃ©gorie demandÃ©e :\n    â†’ Sois honnÃªte : \"Dans la catÃ©gorie [type], nos bijoux dÃ©butent Ã  [prix le plus bas trouvÃ©]â‚¬. Voudrais-tu ajuster ton budget, ou explorer une autre catÃ©gorie oÃ¹ on a des options dans ta fourchette ?\"\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 8 â€” GESTION DE L'ACHAT (FLUX OPTIMISÃ‰)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš¡ FLUX DE VENTE EN 4 Ã‰TAPES (RESPECT STRICT DE L'ORDRE) :\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÃ‰TAPE 1 â€” PRÃ‰SENTATION DES PRODUITS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nAprÃ¨s avoir reÃ§u les rÃ©sultats de match_products :\nâ†’ PrÃ©sente les produits selon le format de la Section 7\nâ†’ Termine par une question ouverte pour mesurer l'intÃ©rÃªt : \n  â€¢ \"Qu'en penses-tu ?\"\n  â€¢ \"L'un de ces modÃ¨les te parle ?\"\n  â€¢ \"Tu te vois avec lequel ?\"\n\nâš ï¸ Ã€ CE STADE : NE PROPOSE PAS ENCORE LES OPTIONS D'ACHAT\nâ†’ Laisse le client rÃ©agir et exprimer son intÃ©rÃªt d'abord\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÃ‰TAPE 2 â€” DÃ‰TECTION DE L'INTÃ‰RÃŠT D'ACHAT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nSIGNAUX D'INTÃ‰RÃŠT FAIBLE (le client hÃ©site encore) :\n- \"J'aime bien\"\n- \"C'est joli\"\n- \"IntÃ©ressant\"\n- \"Pas mal\"\n- \"Montre-moi plus de dÃ©tails\"\n\nâ†’ RÃ‰PONSE : Renforce la valeur du produit\n  â€¢ Partage un dÃ©tail artisanal : \"Ce qui est exceptionnel sur cette piÃ¨ce, c'est le travail guillochÃ© fait Ã  la main...\"\n  â€¢ Pose une question de projection : \"Tu l'imagines pour quelle occasion prÃ©cisÃ©ment ?\"\n  â€¢ Propose une comparaison si plusieurs produits : \"Entre ces deux modÃ¨les, lequel correspond le mieux Ã  ton style ?\"\n\nâ†’ NE PROPOSE TOUJOURS PAS LES OPTIONS D'ACHAT\nâ†’ Attends un signal plus fort\n\nSIGNAUX D'INTÃ‰RÃŠT FORT (le client est prÃªt Ã  acheter) :\n- \"Je prends\"\n- \"Je le veux\"\n- \"J'achÃ¨te\"\n- \"Celui-lÃ \"\n- \"C'est bon pour moi\"\n- \"Je vais le prendre\"\n- \"Comment je fais pour l'acheter ?\"\n- \"Ok, allons-y\"\n\nâ†’ MAINTENANT tu passes Ã  l'Ã‰TAPE 3\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÃ‰TAPE 3 â€” PROPOSITION DES OPTIONS D'ACHAT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nDÃ¨s que le client exprime un signal d'intÃ©rÃªt FORT :\n\nâ†’ Ã‰TAPE 3A â€” Confirme et propose les deux options :\n\n\"Excellent choix, [prÃ©nom] ! ğŸ˜Š \n\nComment prÃ©fÃ¨res-tu finaliser ton achat ?\n\n1ï¸âƒ£ En boutique â€” Tu peux venir l'essayer et repartir avec (15 rue de la Paix, Paris)\n2ï¸âƒ£ En ligne â€” Paiement sÃ©curisÃ© et livraison gratuite en 48h\"\n\nâš ï¸ RÃˆGLE ABSOLUE : ATTENDS la rÃ©ponse du client\nâ†’ NE PARTAGE NI l'adresse NI le lien de paiement avant qu'il choisisse explicitement une option\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nÃ‰TAPE 4 â€” FINALISATION SELON L'OPTION CHOISIE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nOPTION A â€” Si le client choisit \"En boutique\" / \"Boutique\" / \"1\" / \"Je viens sur place\" :\n\n\"Parfait ! ğŸª\n\nğŸ“ Adresse : 15 rue de la Paix, 75002 Paris\nğŸ• Horaires : Lundiâ€“Samedi 10hâ€“19h\n\nJe rÃ©serve la [nom du produit] au nom de [prÃ©nom] ! \n\nÃ€ trÃ¨s bientÃ´t ! ğŸ˜Š\"\n\nâ†’ FIN DE LA TRANSACTION\n\nOPTION B â€” Si le client choisit \"En ligne\" / \"Ligne\" / \"2\" / \"Livraison\" / \"Je paie maintenant\" :\n\nâ†’ Envoie UNIQUEMENT le bloc de paiement formatÃ© (sans texte superflu) :\n\n###PAYMENT###\nPRODUCT_ID: [ID exact du produit choisi depuis les mÃ©tadonnÃ©es]\nPRODUCT_NAME: [Nom exact du produit choisi depuis les mÃ©tadonnÃ©es]\nPAYMENT_URL: [URL EXACTE du champ \"payment_link\" depuis les mÃ©tadonnÃ©es â€” commence par gemmyo.com ou buy.stripe.com, JAMAIS par cloudinary]\n###END###\n\nPuis ajoute immÃ©diatement aprÃ¨s :\n\n\"Clique sur le lien ci-dessus pour finaliser ton achat de maniÃ¨re 100% sÃ©curisÃ©e ğŸ”’\n\nâœ… Paiement sÃ©curisÃ© par Stripe\nğŸ“¦ Livraison gratuite en 48h\nğŸ’ Garantie 2 ans\n\nBesoin d'aide ? Je suis lÃ  ! ğŸ˜Š\"\n\nâš ï¸ VÃ‰RIFICATIONS CRITIQUES AVANT D'ENVOYER LE LIEN :\n1. Le PAYMENT_URL vient bien du champ \"payment_link\" des mÃ©tadonnÃ©es (PAS de l'Image du produit)\n2. Le PAYMENT_URL commence par \"gemmyo.com\" ou \"buy.stripe.com\" (PAS par \"res.cloudinary.com\")\n3. Le PRODUCT_ID et PRODUCT_NAME correspondent EXACTEMENT au produit que le client a choisi\n4. Si plusieurs produits ont Ã©tÃ© prÃ©sentÃ©s, assure-toi d'identifier LE BON produit selon la derniÃ¨re phrase du client\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nCAS PARTICULIERS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nCAS 1 : Le client dit \"Les deux options\" ou hÃ©site\nâ†’ Recommande : \"Je te conseille de venir en boutique si tu veux l'essayer avant, sinon la livraison en ligne est super rapide et sÃ©curisÃ©e ! Qu'est-ce qui te convient le mieux ?\"\n\nCAS 2 : Le client demande \"C'est quoi l'adresse ?\" sans avoir choisi\nâ†’ RÃ©ponds : \"Tu prÃ©fÃ¨res venir en boutique alors ? Ou tu hÃ©sites encore entre boutique et livraison ?\"\nâ†’ ATTENDS la confirmation avant de partager l'adresse\n\nCAS 3 : Le client demande \"Envoie-moi le lien\" sans avoir choisi\nâ†’ RÃ©ponds : \"Avec plaisir ! Je t'envoie le lien de paiement sÃ©curisÃ© tout de suite ğŸ˜Š\"\nâ†’ Envoie le bloc ###PAYMENT### immÃ©diatement (considÃ¨re que le client a choisi l'option en ligne)\n\nCAS 4 : Le client dit \"Je rÃ©flÃ©chis\" aprÃ¨s prÃ©sentation des produits\nâ†’ RÃ©ponds : \"Pas de souci ! Prends ton temps ğŸ˜Š Si tu as des questions ou que tu veux revoir un modÃ¨le, n'hÃ©site pas !\"\nâ†’ NE FORCE PAS la vente\n\nCAS 5 : Plusieurs produits prÃ©sentÃ©s, le client dit \"Je prends le premier\" ou \"Le deuxiÃ¨me\"\nâ†’ Identifie PRÃ‰CISÃ‰MENT le produit selon l'ordre de prÃ©sentation\nâ†’ Confirme : \"Parfait, donc la [nom exact du produit choisi] ! Comment tu veux finaliser ton achat ?\"\nâ†’ Continue le flux normalement\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 9 â€” STYLE DE COMMUNICATION\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n- Tutoyer systÃ©matique (on est sur WhatsApp, contexte dÃ©contractÃ©)\n- Messages COURTS : 2-3 lignes max hors produits\n- UNE seule question par message max\n- Ã‰mojis lÃ©gers et appropriÃ©s : ğŸ’ âœ¨ ğŸ˜Š ğŸ‰ ğŸ’ (pas de spam d'Ã©mojis)\n- Ton : chaleureux, professionnel, DIRECT. Pas pompeux, pas trop familier.\n- Si le client est poli ou formel, adapte ton niveau de langage mais reste accessible\n- Sois RAPIDE âš¡ â€” chaque message doit avancer la conversation vers une dÃ©cision\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nSECTION 10 â€” ARBRE DÃ‰CISIONNEL DU FLUX DE VENTE\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nMESSAGE CLIENT\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Contient TYPE + BUDGET ? â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“ OUI\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Lance match_products     â”‚\nâ”‚ PrÃ©sente les produits    â”‚\nâ”‚ Question ouverte finale  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ATTENDS rÃ©action client  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Signal d'intÃ©rÃªt FAIBLE ?       â”‚\nâ”‚ (\"J'aime bien\", \"Pas mal\"...)   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“ OUI\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Renforce la valeur             â”‚\nâ”‚ Pose question de projection    â”‚\nâ”‚ NE PROPOSE PAS OPTIONS ACHAT   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Signal d'intÃ©rÃªt FORT ?         â”‚\nâ”‚ (\"Je prends\", \"Je le veux\"...)  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“ OUI\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Propose 2 options :            â”‚\nâ”‚ 1ï¸âƒ£ Boutique                    â”‚\nâ”‚ 2ï¸âƒ£ En ligne                    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ATTENDS choix du client  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Client choisit      â”‚     â”‚ Client choisit      â”‚\nâ”‚ BOUTIQUE            â”‚     â”‚ EN LIGNE            â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“                           â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Partage adresse     â”‚     â”‚ Envoie bloc         â”‚\nâ”‚ + horaires          â”‚     â”‚ ###PAYMENT###       â”‚\nâ”‚ + confirmation      â”‚     â”‚ avec lien exact     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    â†“                           â†“\n   FIN                         FIN\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nRÃ‰CAPITULATIF DES RÃˆGLES CRITIQUES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… PRÃ‰SENTE d'abord les produits avec une question ouverte\nâœ… MESURE l'intÃ©rÃªt du client (faible ou fort)\nâœ… RENFORCE la valeur si intÃ©rÃªt faible\nâœ… PROPOSE les options (boutique/ligne) UNIQUEMENT si intÃ©rÃªt fort\nâœ… ATTENDS le choix explicite du client\nâœ… ENVOIE l'adresse OU le lien selon le choix (jamais les deux, jamais avant)\nâœ… VÃ‰RIFIE que le PAYMENT_URL est bien le lien de paiement (gemmyo.com / stripe), pas l'image (cloudinary)\nâœ… POUR IMAGES : Fais confiance Ã  Gemini pour le TYPE de bijou, pas au texte du client\nâœ… CONSTRUIS une requÃªte ultra-descriptive en 1 SEUL appel Ã  match_products\nâœ… PRÃ‰SENTE maximum 2 produits, garde les meilleurs scores\nâœ… DÃ‰DUPLIQUE si plusieurs chunks du mÃªme produit\nâœ… NE PRÃ‰SENTE PAS de produits avec score < 0.4\n"
        }
      },
      "id": "ae2f0d06-cbbe-49e5-be46-8a56731a6bcd",
      "name": "AI Sales Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -1056,
        560
      ]
    },
    {
      "parameters": {
        "model": "openai/gpt-4o-mini",
        "options": {
          "maxTokens": 1500,
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1184,
        832
      ],
      "id": "3df5af20-e29c-4800-a0e2-70b96a3ae5af",
      "name": "GPT-4o Mini",
      "credentials": {
        "openRouterApi": {
          "id": "3r9jm4FmGL6bbFO3",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "=Recherche de produits bijoux dans le catalogue. Utilise une description prÃ©cise incluant : type de bijou, matiÃ¨re, pierres, style. Exemple : 'bague solitaire or blanc diamant 1 carat style moderne'",
        "tableName": {
          "__rl": true,
          "mode": "id",
          "value": "products_vector"
        },
        "topK": 6,
        "useReranker": true,
        "options": {
          "queryName": "match_products"
        }
      },
      "id": "aa8136e8-79ba-4bee-83c3-bc8763ffd804",
      "name": "Vector Store (Products)",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -720,
        784
      ],
      "credentials": {
        "supabaseApi": {
          "id": "vEtDNy0oseTQSIn1",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "BAAI/bge-m3",
        "options": {}
      },
      "id": "ecc7f35c-3822-458a-9d52-062b296c785e",
      "name": "Embeddings (BGE-M3)",
      "type": "@n8n/n8n-nodes-langchain.embeddingsHuggingFaceInference",
      "typeVersion": 1,
      "position": [
        -848,
        1024
      ],
      "credentials": {
        "huggingFaceApi": {
          "id": "qcg257qxfb9C1dPu",
          "name": "HuggingFaceApi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -976,
        816
      ],
      "id": "498f2e84-c609-438b-a8a2-c6bfd89dbc4b",
      "name": "Conversation Memory",
      "credentials": {
        "postgres": {
          "id": "H216ellbOHPwgxCk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parser la rÃ©ponse de l'agent pour extraire texte, produits et paiements\nconst input = items[0].json.output;\nconst results = [];\n\n// Fonction pour nettoyer le texte\nfunction cleanText(text) {\n    if (!text) return '';\n    return text\n        .replace(/```[\\s\\S]*?```/g, '')\n        .replace(/```/g, '')\n        .replace(/\\*\\*/g, '')\n        .replace(/\\*/g, '')\n        .trim();\n}\n\n// Nettoyer l'input des blocs markdown\nlet cleanedInput = input.replace(/```[\\s\\S]*?```/g, (match) => {\n    return match.replace(/```\\n?/g, '').trim();\n});\n\n// 1. EXTRAIRE LE TEXTE AVANT LES PRODUITS (Intro)\nconst introText = cleanedInput.split(/###PRODUCT###/)[0].trim();\n\nif (introText && !introText.includes('###PAYMENT###')) {\n    const cleaned = cleanText(introText);\n    if (cleaned) {\n        results.push({\n            json: {\n                type: 'text',\n                content: cleaned,\n                whatsappId: items[0].json.whatsappId,\n                customerName: items[0].json.customerName,\n                phoneNumberId: items[0].json.phoneNumberId\n            }\n        });\n    }\n}\n\n// 2. EXTRAIRE LES PRODUITS\nconst productBlocks = cleanedInput.match(/###PRODUCT###[\\s\\S]*?###END###/g) || [];\n\nproductBlocks.forEach(block => {\n    const nameMatch = block.match(/NAME:\\s*(.+?)(?=\\n|$)/);\n    const priceMatch = block.match(/PRICE:\\s*(.+?)(?=\\n|$)/);\n    const descMatch = block.match(/DESCRIPTION:\\s*([\\s\\S]*?)(?=IMAGE_URL|PRODUCT_ID|###END###)/);\n    const imageMatch = block.match(/IMAGE_URL:\\s*(https?:\\/\\/[^\\s\\n)]+)/);\n    const idMatch = block.match(/PRODUCT_ID:\\s*(.+?)(?=\\n|###END###|$)/);\n\n    const name = nameMatch ? cleanText(nameMatch[1]) : '';\n    const price = priceMatch ? cleanText(priceMatch[1]) : '';\n    const description = descMatch ? cleanText(descMatch[1]) : '';\n    const imageUrl = imageMatch ? imageMatch[1].trim() : '';\n    const productId = idMatch ? cleanText(idMatch[1]) : '';\n\n    if (name && imageUrl) {\n        results.push({\n            json: {\n                type: 'product',\n                productName: name,\n                productPrice: price,\n                productDescription: description,\n                productImage: imageUrl,\n                productId: productId,\n                whatsappId: items[0].json.whatsappId,\n                customerName: items[0].json.customerName,\n                phoneNumberId: items[0].json.phoneNumberId\n            }\n        });\n    }\n});\n\n// 3. EXTRAIRE LE TEXTE APRÃˆS LES PRODUITS (Conclusion)\nconst parts = cleanedInput.split(/###END###/);\nconst outroText = parts[parts.length - 1]\n    .replace(/###PAYMENT###[\\s\\S]*$/, '')\n    .trim();\n\nif (outroText && outroText !== introText && !outroText.includes('###PRODUCT###')) {\n    const cleaned = cleanText(outroText);\n    if (cleaned) {\n        results.push({\n            json: {\n                type: 'text',\n                content: cleaned,\n                whatsappId: items[0].json.whatsappId,\n                customerName: items[0].json.customerName,\n                phoneNumberId: items[0].json.phoneNumberId\n            }\n        });\n    }\n}\n\n// 4. EXTRAIRE LE PAIEMENT\nconst paymentBlock = cleanedInput.match(/###PAYMENT###([\\s\\S]*?)###END###/)?.[1];\n\nif (paymentBlock) {\n    const productIdMatch = paymentBlock.match(/PRODUCT_ID:\\s*(.+?)(?=\\n|$)/);\n    const productNameMatch = paymentBlock.match(/PRODUCT_NAME:\\s*(.+?)(?=\\n|$)/);\n    const paymentUrlMatch = paymentBlock.match(/PAYMENT_URL:\\s*(https?:\\/\\/[^\\s\\n]+)/);\n\n    const productId = productIdMatch ? cleanText(productIdMatch[1]) : '';\n    const productName = productNameMatch ? cleanText(productNameMatch[1]) : '';\n    const paymentUrl = paymentUrlMatch ? paymentUrlMatch[1].trim() : '';\n\n    if (paymentUrl) {\n        const paymentMessage = `ğŸ›ï¸ ${productName}\\n\\nğŸ”— Lien de paiement :\\n${paymentUrl}\\n\\nâœ… Paiement 100% sÃ©curisÃ©`;\n        \n        results.push({\n            json: {\n                type: 'payment',\n                content: paymentMessage,\n                productId: productId,\n                productName: productName,\n                paymentUrl: paymentUrl,\n                whatsappId: items[0].json.whatsappId,\n                customerName: items[0].json.customerName,\n                phoneNumberId: items[0].json.phoneNumberId\n            }\n        });\n    }\n}\n\n// Si aucun rÃ©sultat, retourner un message par dÃ©faut\nif (results.length === 0) {\n    results.push({\n        json: {\n            type: 'text',\n            content: cleanText(cleanedInput) || 'DÃ©solÃ©, je n\\'ai pas pu traiter ta demande. Peux-tu reformuler ?',\n            whatsappId: items[0].json.whatsappId,\n            customerName: items[0].json.customerName,\n            phoneNumberId: items[0].json.phoneNumberId\n        }\n    });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -640,
        560
      ],
      "id": "bbd068db-3f38-4bf8-8058-0509eec9cb97",
      "name": "Parse Agent Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "527be8fb-30b4-4670-9bdf-715530160568"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type}}",
                    "rightValue": "product",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4faa6ba9-d95d-4a92-b443-021fee87abb8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Product Response"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "payment",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "74dd3502-d1e1-4e23-bd9b-d801c4ec0680"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Payment Response"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -416,
        528
      ],
      "id": "ea785274-169c-49aa-9d83-83b4802b5bfd",
      "name": "Route Response Type"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger1').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}",
        "textBody": "={{ $json.content }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -128,
        336
      ],
      "id": "20cf1018-fd8d-450c-8a9e-72e380c1b407",
      "name": "Send Text Message",
      "webhookId": "e96faaf5-c453-4667-8559-b842fa0c1ef5",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger1').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}",
        "messageType": "image",
        "mediaLink": "={{ $json.productImage }}",
        "additionalFields": {
          "mediaCaption": "=ğŸ’ {{ $json.productName }}\n\nğŸ’° Prix : {{ $json.productPrice }}\n\n{{ $json.productDescription }}"
        }
      },
      "id": "bd1de992-ef4f-4a84-85c9-3d80ffb46611",
      "name": "Send Product Image",
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -128,
        544
      ],
      "webhookId": "b333df7b-63a7-44dd-95de-5ec479e27ff9",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger1').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}",
        "textBody": "={{ $json.content }}",
        "additionalFields": {
          "previewUrl": false
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -128,
        800
      ],
      "id": "38e83c9d-e95e-48ed-83ec-9b6620e8401b",
      "name": "Send Payment Link",
      "webhookId": "1e2e47f8-6de8-4e75-8cd2-2d4d4c5c5ea6",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.rawMessage.audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -2224,
        624
      ],
      "id": "4f46779f-842d-47a1-ad5b-5037ae79e9cc",
      "name": "Get Audio URL1",
      "webhookId": "eacf998b-53b1-4755-99bc-f51d6a871ae1",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2048,
        624
      ],
      "id": "47a25e91-e6cf-48e9-a20b-cd415356ea7a",
      "name": "Download Audio1",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.rawMessage.image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -2224,
        832
      ],
      "id": "65e6119c-4fee-4795-9251-7291cbbc2a45",
      "name": "Get Image URL1",
      "webhookId": "529f65f4-9370-4733-8714-d81d81d84392",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2048,
        832
      ],
      "id": "378085d7-004b-4562-aab6-bf91d44656f6",
      "name": "Download Image1",
      "credentials": {
        "whatsAppApi": {
          "id": "5HG4bSxsqnpZD9cA",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "prospects",
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp_id",
              "condition": "eq",
              "keyValue": "={{ $json.contacts[0].wa_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $('WhatsApp Trigger1').item.json.contacts[0].profile.name }}"
            },
            {
              "fieldId": "last_interaction",
              "fieldValue": "={{ $now }}"
            },
            {
              "fieldId": "conversation_count",
              "fieldValue": "={{ $json.conversation_count ? $json.conversation_count + 1 : 1 }}"
            }
          ]
        }
      },
      "id": "8c1b6466-757b-495b-ac23-b52dbbae4474",
      "name": "Update CRM1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        288,
        608
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "vEtDNy0oseTQSIn1",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json['Image du produit'][0].thumbnails.card_cover.signedUrl }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-cloudinary.cloudinary",
      "typeVersion": 1,
      "position": [
        528,
        0
      ],
      "id": "fbc0cec8-abad-41c4-a9ae-d9f040cb4502",
      "name": "Upload an asset from URL",
      "credentials": {
        "cloudinaryApi": {
          "id": "esBLp1DAQT61XI2I",
          "name": "Cloudinary account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.rerankerCohere",
      "typeVersion": 1,
      "position": [
        -592,
        992
      ],
      "id": "65e112ea-7bb7-4a0c-855d-b6ab5b7c8873",
      "name": "Reranker Cohere",
      "credentials": {
        "cohereApi": {
          "id": "caivPdTlkNh9Giwc",
          "name": "CohereApi account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Get many rows1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger1": {
      "main": [
        [
          {
            "node": "Extract Basic Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Vector": {
      "main": [
        [
          {
            "node": "Insert to Vector DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Document Loader": {
      "ai_document": [
        [
          {
            "node": "Insert to Vector DB",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Insert": {
      "ai_embedding": [
        [
          {
            "node": "Insert to Vector DB",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Document Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows1": {
      "main": [
        [
          {
            "node": "Split Out1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out1": {
      "main": [
        [
          {
            "node": "Upload an asset from URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Basic Info": {
      "main": [
        [
          {
            "node": "Route by Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Message Type": {
      "main": [
        [
          {
            "node": "Process Text Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Audio URL1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Image URL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Text Message": {
      "main": [
        [
          {
            "node": "Merge All Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe Audio (Deepgram)": {
      "main": [
        [
          {
            "node": "Process Audio Transcript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Audio Transcript": {
      "main": [
        [
          {
            "node": "Merge All Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Image (Gemini)": {
      "main": [
        [
          {
            "node": "Process Image Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Image Analysis": {
      "main": [
        [
          {
            "node": "Merge All Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Inputs": {
      "main": [
        [
          {
            "node": "AI Sales Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Sales Agent": {
      "main": [
        [
          {
            "node": "Parse Agent Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4o Mini": {
      "ai_languageModel": [
        [
          {
            "node": "AI Sales Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Vector Store (Products)": {
      "ai_tool": [
        [
          {
            "node": "AI Sales Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings (BGE-M3)": {
      "ai_embedding": [
        [
          {
            "node": "Vector Store (Products)",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Conversation Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Sales Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse Agent Response": {
      "main": [
        [
          {
            "node": "Route Response Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Response Type": {
      "main": [
        [
          {
            "node": "Send Text Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Product Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Payment Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Text Message": {
      "main": [
        [
          {
            "node": "Update CRM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Product Image": {
      "main": [
        [
          {
            "node": "Update CRM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Payment Link": {
      "main": [
        [
          {
            "node": "Update CRM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio URL1": {
      "main": [
        [
          {
            "node": "Download Audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio1": {
      "main": [
        [
          {
            "node": "Transcribe Audio (Deepgram)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image URL1": {
      "main": [
        [
          {
            "node": "Download Image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image1": {
      "main": [
        [
          {
            "node": "Analyze Image (Gemini)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload an asset from URL": {
      "main": [
        [
          {
            "node": "Prepare for Vector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reranker Cohere": {
      "ai_reranker": [
        [
          {
            "node": "Vector Store (Products)",
            "type": "ai_reranker",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "c93a7b4c-b0ef-4cae-943e-da6ff6fb3d74",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c654f13d1fe3cf34a5535e45d0476a4d417e5b3ad000202464c3eae8ae7b62c7"
  },
  "id": "eRPt9uVE-UsEadVRxB1A1",
  "tags": []
}
