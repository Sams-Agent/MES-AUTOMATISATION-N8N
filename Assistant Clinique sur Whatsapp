{
  "name": "Assisatant clinique sur whatsapp",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        352,
        400
      ],
      "id": "9d730574-8f60-4c21-80aa-d16c428d4806",
      "name": "WhatsApp Trigger",
      "webhookId": "1d154858-b55f-489b-ac96-a598b1c5df19",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "eXbOJhp2DmHAixte",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "messages",
        "limit": 15,
        "filterType": "string",
        "filterString": "=conversation_id=eq.{{ $json.conversation_id }}&order=created_at.desc"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1952,
        384
      ],
      "id": "0487d9a6-2390-41b4-b6d9-5dbb331265dd",
      "name": "Get Last 15 Messages",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "phone_field",
              "name": "phone",
              "value": "={{ $json.messages[0].from }}",
              "type": "string"
            },
            {
              "id": "patient_name_field",
              "name": "patient_name",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "wa_id_field",
              "name": "wa_id",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "fieldId": "message_field",
              "name": "message",
              "value": "={{ $json.messages[0].text?.body || 'Message re√ßu' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        624,
        400
      ],
      "id": "22048bd3-1462-4e9d-8f6f-08252763b875",
      "name": "Extract Fields1"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "conversations",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "keyValue": "={{ $json.phone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        864,
        384
      ],
      "id": "44acaea8-d4d6-4917-9e83-441a46967d02",
      "name": "Check Existing Conversation1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check_conversation_exists",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1040,
        384
      ],
      "id": "2a7d4264-b079-46bd-ad54-ca49a45114dd",
      "name": "Is Existing Patient?1"
    },
    {
      "parameters": {
        "tableId": "conversations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Extract Fields1').item.json.phone }}"
            },
            {
              "fieldId": "patient_name",
              "fieldValue": "={{ $('Extract Fields1').item.json.patient_name }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "NOUVEAU"
            },
            {
              "fieldId": "step",
              "fieldValue": "INITIAL"
            },
            {
              "fieldId": "status",
              "fieldValue": "ACTIVE"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1216,
        544
      ],
      "id": "7bcea128-628b-45e1-a1b1-be9d31a66480",
      "name": "Create New Conversation1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1408,
        384
      ],
      "id": "bef37bb1-9eda-452d-b26a-cc3f6a2b56b7",
      "name": "Merge Conversations1"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst originalMessage = $('Extract Fields1').first().json.message;\nconst originalPhone = $('Extract Fields1').first().json.phone;\n\nreturn items.map(item => {\n  const conversationId = item.json.id || item.json.id_1;\n  \n  return {\n    json: {\n      conversation_id: conversationId,\n      phone: originalPhone,\n      patient_name: item.json.patient_name,\n      last_intent: item.json.last_intent,\n      step: item.json.step,\n      status: item.json.status,\n      motif: item.json.motif,\n      date_souhaitee: item.json.date_souhaitee,\n      rdv_datetime: item.json.rdv_datetime,\n      message: originalMessage\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        384
      ],
      "id": "0566f004-b523-4ab1-9ac4-57a2e1b9e479",
      "name": "Normalize Conversation ID1"
    },
    {
      "parameters": {
        "tableId": "messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_id",
              "fieldValue": "={{ $json.conversation_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "user"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.message }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1776,
        384
      ],
      "id": "9f89c78a-eeb2-4c51-a672-d209bebe04e5",
      "name": "Save User Message1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const messages = $input.all();\nconst conversation = $('Normalize Conversation ID1').first().json;\n\nconst currentMessage = conversation.message || '';\n\nconst historyText = messages.reverse().slice(-10).map(msg => \n  `${msg.json.role === 'user' ? 'Patient' : 'Assistant'}: ${msg.json.content}`\n).join('\\n');\n\nconst contextMessage = `\nPatient: ${conversation.patient_name || 'Inconnu'}\nT√©l√©phone: ${conversation.phone || 'Non d√©tect√©'} \n√âtape: ${conversation.step || 'INITIAL'}\nIntention: ${conversation.last_intent || 'Aucune'}\nMotif: ${conversation.motif || 'Non renseign√©'}\nDate souhait√©e: ${conversation.date_souhaitee || 'Non renseign√©e'}\nRDV existant: ${conversation.rdv_datetime || 'Aucun'}\n`;\n\nconst maintenant = new Date();\nconst dateLisible = maintenant.toLocaleDateString('fr-FR', { \n  weekday: 'long', \n  year: 'numeric', \n  month: 'long', \n  day: 'numeric' \n});\n\nreturn [{\n  json: {\n    formatted_history: historyText,\n    context: contextMessage,\n    current_message: currentMessage,\n    date_du_jour: dateLisible,\n    phone: conversation.phone, \n    conversation_id: conversation.conversation_id,\n    patient_name: conversation.patient_name || 'Inconnu'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        384
      ],
      "id": "ef830f7d-cfa2-4db8-8c5c-f2a5159059eb",
      "name": "Format History for AI1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=HISTORIQUE R√âCENT (10 derniers messages):\n{{ $json.formatted_history }}\n\nCONTEXTE PATIENT:\n{{ $json.context }}\n\nDATE DU JOUR:\n{{ $json.date_du_jour }}\n\nMESSAGE √Ä TRAITER:\n{{ $json.current_message }}",
        "options": {
          "systemMessage": "=Tu es l'assistant IA expert de la **Clinique Divine Mis√©ricorde** üè•. Ton r√¥le est de g√©rer les conversations WhatsApp avec professionnalisme, empathie et chaleur humaine.\n\n## üòä STYLE DE COMMUNICATION HOSPITALIER\n\n**UTILISATION DES EMOJIS (IMPORTANT) :**\nTu dois utiliser des emojis de mani√®re naturelle et fr√©quente pour cr√©er une ambiance chaleureuse et rassurante. Voici les emojis √† privil√©gier :\n\n**Emojis m√©dicaux/sant√© :**\nüè• Clinique/h√¥pital | üíä M√©dicaments | ü©∫ Consultation | üå°Ô∏è Fi√®vre | üíâ Soins | üöë Urgence | ‚ù§Ô∏è‚Äçü©π Gu√©rison | ü©π Premiers soins\n\n**Emojis organisationnels :**\nüìÖ Rendez-vous | ‚è∞ Heure | ‚úÖ Confirmation | üìù Note | üìû Contact | ‚úâÔ∏è Message\n\n**Emojis √©motionnels/empathiques :**\nüòä Accueil | üôè Compassion | üíô Bienveillance | üòå R√©confort | ü§ó Soutien | üí™ Encouragement\n\n**Emojis d'urgence/alerte :**\nüö® URGENCE VITALE | ‚ö†Ô∏è Attention | ‚è±Ô∏è Rapidit√© | üî¥ Priorit√©\n\n**R√àGLES D'USAGE DES EMOJIS :**\n- Utilise 2-4 emojis par message\n- Place-les naturellement dans le texte\n- Privil√©gie les emojis m√©dicaux pour cr√©er le contexte hospitalier\n- Ajoute des emojis √©motionnels pour l'empathie\n\n## üìÖ R√âF√âRENCE TEMPORELLE\n- Aujourd'hui: {{ $json.date_du_jour }}\n- Ann√©e: 2026\n- Fuseau: UTC+01:00\n- Format date: ISO8601 strict ‚Üí YYYY-MM-DDTHH:MM:00+01:00\n\n## üïê HORAIRES CLINIQUE\n- Jours: Lundi-Vendredi\n- Heures: 08h00-18h00\n- Pause: 12h30-14h00 (pas de RDV)\n- Cr√©neaux standards: 08h30, 09h00, 09h30, 10h00, 10h30, 11h00, 11h30, 14h00, 14h30, 15h00, 15h30, 16h00, 16h30, 17h00, 17h30\n\n## üõ†Ô∏è TES 5 OUTILS\n\n### 1. FAQ Tool\nQuestions sur horaires, adresse, tarifs. Utilise keywords de la question.\n\n### 2. Calendar Availability Tool\n**ATTENTION CRITIQUE : Retourne les √âV√âNEMENTS EXISTANTS, PAS les cr√©neaux libres.**\n\n**LOGIQUE D'INTERPR√âTATION :**\n- After : D√©but journ√©e (ex: 2026-02-10T08:00:00+01:00)\n- Before : Fin journ√©e (ex: 2026-02-10T18:00:00+01:00)\n- Return_All : false\n- Limit : 50\n\n**INTERPR√âTATION DU RETOUR :**\n- `[]` (vide) = Journ√©e LIBRE ‚Üí Propose cr√©neaux standards (09h00, 11h00, 14h30)\n- `[√©v√©nements]` = Ces cr√©neaux sont OCCUP√âS ‚Üí Propose cr√©neaux NON pr√©sents dans le retour\n\n### 3. Calendar Create Event Tool\n‚úÖ Utilise si: nom, motif, cr√©neau confirm√©, cr√©neau libre\n\nParam√®tres:\n- Summary: \"RDV M√©dical - [Nom Pr√©nom]\"\n- Description: \"Motif: [motif] | Contact: [phone]\"\n- Start: ISO8601 (ex: 2026-02-09T10:00:00+01:00)\n- End: Start + 30min\n\n### 4. Triage Creation Tool\n**Quand :** Patient d√©crit sympt√¥mes inqui√©tants\n\n**Sympt√¥mes d√©clencheurs :**\nDouleurs, fi√®vre, saignements, vertiges, naus√©es, vomissements, difficult√©s respiratoires, douleurs thoraciques\n\n**PROCESSUS INTELLIGENT (3-4 questions selon sympt√¥me) :**\n\n**Pour DOULEURS (4 questions) :**\n1. Depuis quand ? ‚Üí depuis_quand\n2. Intensit√© 1-10 ? ‚Üí intensite (NUMBER)\n3. O√π exactement ? ‚Üí localisation\n4. Autres sympt√¥mes ? ‚Üí symptomes_associes\n\n**Pour NAUS√âES/FI√àVRE/VERTIGES (3 questions, PAS d'intensit√©) :**\n1. Depuis quand ? ‚Üí depuis_quand\n2. Fr√©quence/Temp√©rature/Contexte ? ‚Üí localisation\n3. Autres sympt√¥mes ? ‚Üí symptomes_associes\n\n**PARAM√àTRES TRIAGE TOOL :**\n```javascript\n{\n  conversation_id: \"{{ $json.conversation_id }}\",\n  phone: \"{{ $json.phone }}\",\n  patient_name: \"{{ $json.patient_name }}\",\n  initial_message: \"[Premier message sympt√¥me]\",\n  depuis_quand: \"[Dur√©e]\",\n  intensite: [NUMBER 1-10 ou ne pas envoyer si pas douleur],\n  localisation: \"[Localisation si douleur OU fr√©quence/temp√©rature]\",\n  symptomes_associes: \"[Description compl√®te]\",\n  urgency: \"low\"|\"medium\"|\"high\"|\"urgent\",\n  status: \"PENDING\"\n}\n```\n\n**√âVALUATION URGENCE :**\n| Intensit√© | Urgence | D√©lai | Action |\n|-----------|---------|-------|--------|\n| 1-3 | low | Pas urgent | Proposer RDV |\n| 4-6 | medium | 24-48h | √âquipe recontactera |\n| 7-8 | high | Quelques heures | Contacte dans l'heure |\n| 9-10 | urgent | IMM√âDIAT | üö® APPELER 15 |\n\n**R√âPONSES SELON URGENCE :**\n\n- **urgent :** \"üö® URGENCE VITALE üö®\\n\\nVOS SYMPT√îMES N√âCESSITENT UNE PRISE EN CHARGE IMM√âDIATE ‚ö†Ô∏è\\n\\nüëâ APPELEZ LE 15 (SAMU) MAINTENANT üìû\\n\\nNe perdez pas de temps. Votre vie est en danger. üöë\"\n\n- **high :** \"Vos sympt√¥mes sont pr√©occupants ‚ö†Ô∏è\\n\\nNotre √©quipe m√©dicale ü©∫ a √©t√© alert√©e et vous contactera dans l'heure üìû\\n\\nSi votre √©tat s'aggrave, appelez le 15 imm√©diatement üöë\\n\\nEn attendant, restez au repos üòå\"\n\n- **medium :** \"Merci pour ces informations üìù\\n\\nNotre √©quipe m√©dicale ü©∫ a √©t√© notifi√©e et vous recontactera dans les 24 heures üìû\"\n\n- **low :** \"Merci pour ces informations üìù\\n\\nCes sympt√¥mes ne semblent pas n√©cessiter une prise en charge urgente üòå\"\n\n### 5. Update Conversation Tool\nSauvegarde apr√®s chaque √©tape importante.\n\nSteps possibles:\nINITIAL, ASK_NAME, ASK_MOTIF, ASK_DATE, PROPOSE_SLOTS, RDV_CONFIRM√â, TRIAGE_INITI√â, TRIAGE_ENREGISTR√â, FAQ_R√âPONDUE\n\n## üí¨ PROTOCOLE COMPLET - ‚ö†Ô∏è R√àGLE ABSOLUE\n\n### üî¥ R√àGLE D'OR SUPR√äME - √Ä RESPECTER ABSOLUMENT :\n\n**SI LE PATIENT DEMANDE UN RDV + MENTIONNE DES SYMPT√îMES :**\n1. Faire le TRIAGE (3-4 questions)\n2. Enregistrer le triage (Triage Creation Tool)\n3. Informer de l'alerte m√©dicale\n4. **TOUJOURS ENCHA√éNER AVEC LA PRISE DE RDV** ‚Üê OBLIGATOIRE\n\n**NE JAMAIS s'arr√™ter apr√®s le triage si le patient a demand√© un RDV au d√©part.**\n\n---\n\n### INTENT_RDV_SIMPLE (sans sympt√¥mes)\n1. Saluer üòä\n2. Demander motif (simple, sans sympt√¥mes m√©dicaux)\n3. Demander date üìÖ\n4. Calendar Availability\n5. Proposer 3 cr√©neaux LIBRES ‚è∞\n6. Confirmer choix ‚úÖ\n7. Calendar Create Event\n8. Update Conversation (step: RDV_CONFIRM√â)\n9. Confirmation finale\n\n---\n\n### INTENT_RDV_AVEC_SYMPT√îMES ‚ö†Ô∏è PROTOCOLE COMBIN√â OBLIGATOIRE\n\n**D√©clencheur :** Patient dit \"je veux un RDV\" + mentionne sympt√¥mes (naus√©es, douleur, fi√®vre, vertiges, etc.)\n\n**PHASE 1 : TRIAGE M√âDICAL (3-4 questions)**\n\n1. Identifier le type de sympt√¥me (douleur vs autre)\n\n2. **Dire explicitement qu'on va d'abord √©valuer les sympt√¥mes :**\n   \"D'accord [Nom] üòä Avant de prendre votre rendez-vous, j'ai besoin d'√©valuer vos sympt√¥mes pour alerter notre √©quipe m√©dicale si n√©cessaire üìù\"\n\n3. Poser les 3-4 questions adapt√©es\n\n4. Triage Creation Tool (attention: intensite = NUMBER ou NULL)\n\n5. Informer de l'alerte m√©dicale selon urgency\n\n**PHASE 2 : PRISE DE RDV (OBLIGATOIRE - NE JAMAIS OUBLIER)**\n\n6. **TRANSITION OBLIGATOIRE vers la prise de RDV :**\n\n   Si urgency = \"urgent\" ou \"high\" :\n   ```\n   En parall√®le de cette alerte, prenons votre rendez-vous d√®s que possible üìÖ\n   \n   Pour quelle date souhaitez-vous consulter ?\n   ```\n\n   Si urgency = \"medium\" ou \"low\" :\n   ```\n   Maintenant, prenons votre rendez-vous üìÖ\n   \n   Pour quelle date souhaitez-vous consulter ?\n   ```\n\n7. Demander date souhait√©e\n\n8. Calendar Availability\n\n9. Proposer 3 cr√©neaux LIBRES ‚è∞\n\n10. Confirmer choix ‚úÖ\n\n11. Calendar Create Event (motif doit inclure les sympt√¥mes)\n\n12. Update Conversation (step: RDV_CONFIRM√â, motif: \"Consultation - [sympt√¥mes]\")\n\n13. **Confirmation finale compl√®te :**\n    ```\n    Excellent ! ‚úÖ Votre rendez-vous est confirm√© üìÖ\n    \n    üìç Clinique Divine Mis√©ricorde üè•\n    üìÖ [Date compl√®te]\n    ‚è∞ [Heure]\n    ü©∫ Consultation - [sympt√¥mes r√©sum√©s]\n    \n    Notre √©quipe m√©dicale vous contactera √©galement suite √† votre triage üìû\n    \n    √Ä tr√®s bient√¥t [Nom] ! üòä\n    ```\n\n**EXEMPLE COMPLET :**\n```\nPatient : \"Je veux un RDV, j'ai des naus√©es depuis 2 jours\"\n\n[PHASE 1 : TRIAGE]\nAssistant : \"D'accord Samson üòä Avant de prendre votre rendez-vous, j'ai besoin d'√©valuer vos sympt√¥mes pour alerter notre √©quipe m√©dicale si n√©cessaire üìù\\n\\nDepuis quand exactement avez-vous ces naus√©es ? ‚è±Ô∏è\"\n\nPatient : \"Depuis avant-hier\"\n\nAssistant : \"√Ä quelle fr√©quence avez-vous des naus√©es ? Vomissez-vous ? ü§¢\"\n\nPatient : \"Oui, surtout le matin\"\n\nAssistant : \"Avez-vous d'autres sympt√¥mes comme de la fi√®vre ? ü§í\"\n\nPatient : \"Oui un peu\"\n\n[Triage Tool appel√© ‚Üí urgency = medium]\n\nAssistant : \"Merci pour ces informations üìù\\n\\nNotre √©quipe m√©dicale ü©∫ a √©t√© notifi√©e et vous recontactera dans les 24 heures üìû\\n\\n[PHASE 2 : RDV - TRANSITION]\nMaintenant, prenons votre rendez-vous üìÖ\\n\\nPour quelle date souhaitez-vous consulter ?\"\n\nPatient : \"Demain si possible\"\n\n[Calendar Availability ‚Üí retour []]\n\nAssistant : \"Parfait ! üòä Demain est disponible.\\n\\nJe vous propose ‚è∞ :\\n‚Ä¢ 09h00\\n‚Ä¢ 11h00\\n‚Ä¢ 14h30\\n\\nLequel vous convient ?\"\n\nPatient : \"11h\"\n\n[Calendar Create Event]\n[Update Conversation]\n\nAssistant : \"Excellent ! ‚úÖ Votre rendez-vous est confirm√© üìÖ\\n\\nüìç Clinique Divine Mis√©ricorde üè•\\nüìÖ Mercredi 5 f√©vrier 2026\\n‚è∞ 11h00\\nü©∫ Consultation - Naus√©es et fi√®vre\\n\\nNotre √©quipe m√©dicale vous contactera √©galement suite √† votre triage üìû\\n\\n√Ä tr√®s bient√¥t Samson ! üòä\"\n```\n\n---\n\n### INTENT_TRIAGE_SEUL (sympt√¥mes SANS demande de RDV)\n\n**D√©clencheur :** Patient d√©crit sympt√¥mes SANS dire \"je veux un RDV\"\n\n**Processus :**\n1. Identifier sympt√¥me\n2. Poser 3-4 questions\n3. Triage Creation Tool\n4. Informer selon urgency\n5. Conseils de confort\n6. **TOUJOURS proposer RDV √† la fin :**\n   \"Souhaitez-vous prendre un rendez-vous de consultation pour ces sympt√¥mes ? üìÖ\"\n7. Si oui ‚Üí Lancer processus RDV complet (date, cr√©neaux, confirmation)\n\n---\n\n### INTENT_FAQ\n1. FAQ Tool avec keywords\n2. R√©pondre avec emojis üíô\n3. Proposer RDV si pertinent\n\n---\n\n## üö´ S√âCURIT√â\n\n‚ùå NE JAMAIS:\n- Donner diagnostic\n- Recommander m√©dicament\n- Minimiser urgence\n- S'arr√™ter apr√®s triage si RDV demand√© au d√©part\n\n‚úÖ TOUJOURS:\n- \"Seul un m√©decin peut diagnostiquer\" ü©∫\n- Si urgence vitale: \"üö® APPELEZ LE 15 IMM√âDIATEMENT üìû\"\n- Utiliser emojis (2-4 par message)\n- Finir la prise de RDV si le patient l'a demand√©\n\n## üí¨ STYLE\n- Messages courts (2-4 lignes max)\n- Emojis : 2-4 par message (m√©dicaux + √©motionnels)\n- UNE question √† la fois\n- Professionnel + chaleureux\n\n## üíô PHILOSOPHIE\n\nTu repr√©sentes une clinique moderne et humaine. Chaque interaction doit refl√©ter professionnalisme m√©dical ü©∫, chaleur humaine üíô, efficacit√© organisationnelle ‚ö°, empathie sinc√®re ü§ó, et s√©curit√© du patient üõ°Ô∏è.\n\n**Les emojis ne sont pas optionnels - ils font partie de l'identit√© de la Clinique Divine Mis√©ricorde !** üòäüè•üíô\n\nFais de ton mieux pour aider chaque patient ! üåü"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        2320,
        384
      ],
      "id": "7bb74399-e149-4142-8662-bd5d055c2ffa",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "model": "openai/gpt-4o-mini",
        "options": {
          "maxTokens": 500,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1824,
        752
      ],
      "id": "0d1faafe-8253-4200-ab69-c1a94cde623c",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "lC2IpNIo2HD0hYjf",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get many rows in Supabase pour obtenir les infos dans la table faq en fonction de la demande du patient ",
        "operation": "get",
        "tableId": "faq",
        "filters": {
          "conditions": [
            {
              "keyName": "answer",
              "keyValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Value', `Keywords to search in FAQ (comma separated)`, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2000,
        768
      ],
      "id": "3e267c8a-3998-4ba4-87fb-a11e17515ce3",
      "name": "FAQ Tool1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "sabigonnaguian57@gmail.com",
          "mode": "list",
          "cachedResultName": "sabigonnaguian57@gmail.com"
        },
        "returnAll": "={{ $fromAI('Return_All', 'false pour limiter', 'boolean') }}",
        "limit": "={{ $fromAI('Limit', 'Max 50 √©v√©nements', 'number') }}",
        "timeMin": "={{ $fromAI('After', 'ISO8601 d√©but journ√©e: 2026-02-10T08:00:00+01:00', 'string') }}",
        "timeMax": "={{ $fromAI('Before', 'ISO8601 fin journ√©e: 2026-02-10T18:00:00+01:00', 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2176,
        752
      ],
      "id": "c8994c9b-8372-4ec0-b1d6-088a3c1b11ce",
      "name": "Calendar Availability Tool1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "I1W0uKaVADtsxitx",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "sabigonnaguian57@gmail.com",
          "mode": "id"
        },
        "start": "={{ $fromAI('Start', 'ISO8601: 2026-02-10T10:00:00+01:00', 'string') }}",
        "end": "={{ $fromAI('End', 'ISO8601: 2026-02-10T10:30:00+01:00', 'string') }}",
        "additionalFields": {
          "description": "={{ 'Motif: ' + $fromAI('motif', 'Motif consultation', 'string') + ' | Contact: ' + $fromAI('phone', 'T√©l√©phone patient', 'string') }}",
          "summary": "={{ 'RDV M√©dical - ' + $fromAI('patient_name', 'Nom complet patient', 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2352,
        752
      ],
      "id": "40f47c16-0cf6-46ff-b196-17bbe151ebc5",
      "name": "Calendar Create Event Tool1",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "I1W0uKaVADtsxitx",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Save medical triage case. Use when patient describes symptoms. IMPORTANT: 'intensite' is NUMBER 1-10 for PAIN only (don't send for fever/nausea/dizziness without pain). Parameters: conversation_id, phone (from context), patient_name (from context), initial_message, depuis_quand, intensite (NUMBER or don't send), localisation (location for pain OR frequency for nausea OR temperature for fever), symptomes_associes (full description), urgency (low/medium/high/urgent), status (PENDING).",
        "tableId": "triage_cases",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_id",
              "fieldValue": "={{ $fromAI('conversation_id', 'ID conversation', 'string') }}"
            },
            {
              "fieldId": "urgency",
              "fieldValue": "={{ $fromAI('urgency', 'low/medium/high/urgent', 'string') }}"
            },
            {
              "fieldId": "depuis_quand",
              "fieldValue": "={{ $fromAI('depuis_quand', 'Dur√©e: 2 jours, 1 semaine...', 'string') }}"
            },
            {
              "fieldId": "symptomes_associes",
              "fieldValue": "={{ $fromAI('symptomes_associes', 'Description compl√®te sympt√¥mes', 'string') }}"
            },
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('Format History for AI1').item.json.phone }}"
            },
            {
              "fieldId": "patient_name",
              "fieldValue": "={{ $('Format History for AI1').item.json.patient_name }}"
            },
            {
              "fieldId": "intensite",
              "fieldValue": "={{ $fromAI('intensite', 'Intensit√© 1-10 NUMBER (only for pain, NULL if not pain)', 'number') }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $fromAI('status', 'PENDING par d√©faut', 'string') }}"
            },
            {
              "fieldId": "localisation",
              "fieldValue": "={{ $fromAI('localisation', 'Localisation douleur OU fr√©quence naus√©es OU temp√©rature', 'string') }}"
            },
            {
              "fieldId": "initial_message",
              "fieldValue": "={{ $('Format History for AI1').item.json.current_message }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2528,
        736
      ],
      "id": "f5975359-fac9-4e9f-801e-35ccb4a8bd1d",
      "name": "Triage Creation Tool1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Update conversation information with patient details and current step. Use this after each important step to save patient data.",
        "operation": "update",
        "tableId": "conversations",
        "filterType": "string",
        "filterString": "=id=eq.{{ $fromAI('conversation_id', 'ID de la conversation', 'string') }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "patient_name",
              "fieldValue": "={{ $fromAI('patient_name', 'Nom complet du patient', 'string') }}"
            },
            {
              "fieldId": "last_intent",
              "fieldValue": "={{ $fromAI('last_intent', 'INTENT_RDV, INTENT_FAQ, ou INTENT_TRIAGE', 'string') }}"
            },
            {
              "fieldId": "step",
              "fieldValue": "={{ $fromAI('step', 'INITIAL, ASK_NAME, ASK_MOTIF, ASK_DATE, PROPOSE_SLOTS, RDV_CONFIRM√â, etc', 'string') }}"
            },
            {
              "fieldId": "date_souhaitee",
              "fieldValue": "={{ $fromAI('date_souhaitee', 'Date souhait√©e format: 2026-02-09', 'string') }}"
            },
            {
              "fieldId": "motif",
              "fieldValue": "={{ $fromAI('motif', 'Motif de consultation', 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2768,
        720
      ],
      "id": "c40ed47a-0a78-4d19-939a-8268c72d51bf",
      "name": "Update Conversation Tool1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=983081561544380",
        "recipientPhoneNumber": "={{ $('Format History for AI1').item.json.phone }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        2672,
        384
      ],
      "id": "03b4e44e-2079-4c3d-b4cc-a68ee81e4900",
      "name": "Send WhatsApp Message1",
      "webhookId": "auto-generated",
      "credentials": {
        "whatsAppApi": {
          "id": "XZeouCiwhxo4E8ue",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_id",
              "fieldValue": "={{ $('Format History for AI1').item.json.conversation_id }}"
            },
            {
              "fieldId": "role",
              "fieldValue": "assistant"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('AI Agent1').item.json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2880,
        384
      ],
      "id": "37f8f623-cfb3-4505-9512-2b824f2a5c48",
      "name": "Save Assistant Response1",
      "credentials": {
        "supabaseApi": {
          "id": "24deRiWofnxVnaBh",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1104,
        96
      ],
      "id": "d6c09b49-c34f-4d26-b435-527ca182bcc1",
      "name": "V√©rifier toutes les 5min"
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "sabigonnaguian57@gmail.com",
          "mode": "list",
          "cachedResultName": "sabigonnaguian57@gmail.com"
        },
        "options": {
          "timeMin": "={{ $now.plus({ minutes: 25 }).toISO() }}",
          "timeMax": "={{ $now.plus({ minutes: 35 }).toISO() }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        -896,
        96
      ],
      "id": "a43861fc-fc98-4d09-a2bb-bc7d44c2a8d3",
      "name": "R√©cup√©rer RDV dans 25-35min",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "I1W0uKaVADtsxitx",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "has-events",
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -672,
        96
      ],
      "id": "8370e680-879e-466e-9fc7-e166ea013917",
      "name": "Y a-t-il des RDV ?"
    },
    {
      "parameters": {
        "jsCode": "// Pour chaque √©v√©nement, extraire les infos\nconst events = $input.all();\n\nreturn events.map(event => {\n  const description = event.json.description || '';\n  \n  // Extraire le t√©l√©phone du format \"Motif: XXX | Contact: +22963845663\"\n  const phoneMatch = description.match(/Contact:\\s*([\\+\\d]+)/);\n  const phone = phoneMatch ? phoneMatch[1] : null;\n  \n  // Extraire le motif\n  const motifMatch = description.match(/Motif:\\s*([^|]+)/);\n  const motif = motifMatch ? motifMatch[1].trim() : 'Consultation';\n  \n  // Extraire le nom du patient depuis le titre \"RDV M√©dical - Nom Pr√©nom\"\n  const summary = event.json.summary || '';\n  const nameMatch = summary.match(/RDV M√©dical - (.+)/);\n  const patientName = nameMatch ? nameMatch[1] : 'Patient';\n  \n  // Formater l'heure du RDV\n  const startTime = new Date(event.json.start.dateTime);\n  const timeString = startTime.toLocaleTimeString('fr-FR', { \n    hour: '2-digit', \n    minute: '2-digit' \n  });\n  \n  return {\n    json: {\n      event_id: event.json.id,\n      patient_name: patientName,\n      phone: phone,\n      motif: motif,\n      rdv_time: timeString,\n      rdv_datetime: event.json.start.dateTime,\n      description: description,\n      summary: summary\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        96
      ],
      "id": "80ae57f1-5196-4b33-b57e-b4e869fd53ec",
      "name": "Extraire donn√©es √©v√©nements"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-phone",
              "leftValue": "={{ $json.phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -224,
        96
      ],
      "id": "196ff1eb-93c4-4fc5-a174-73f4c7c2677d",
      "name": "A un t√©l√©phone ?"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=983081561544380",
        "recipientPhoneNumber": "={{ $json.phone }}",
        "textBody": "=üîî RAPPEL DE RENDEZ-VOUS üîî\n\nBonjour {{ $json.patient_name }} üòä\n\nVotre consultation √† la Clinique Divine Mis√©ricorde üè• est dans 30 minutes !\n\nüìÖ Aujourd'hui\n‚è∞ {{ $json.rdv_time }}\nü©∫ {{ $json.motif }}\n\nüìç Adresse: Clinique Divine Mis√©ricorde\n\nMerci de votre confiance üíô\n\n√Ä tout de suite ! üòä",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "78a80592-30a5-4971-a44a-5b260e904540",
      "name": "Rappel WhatsApp Patient",
      "webhookId": "c5090f7d-9b33-4a8b-ba70-25d729c24d68",
      "credentials": {
        "whatsAppApi": {
          "id": "XZeouCiwhxo4E8ue",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=983081561544380",
        "recipientPhoneNumber": "+22957847432",
        "textBody": "=üìã NOTIFICATION CLINIQUE üìã\n\nRDV dans 30 minutes ‚è∞\n\nPatient: {{ $json.patient_name }}\nHeure: {{ $json.rdv_time }}\nMotif: {{ $json.motif }}\nT√©l√©phone: {{ $json.phone }}\n\nüè• Pr√©parez la salle de consultation",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -16,
        176
      ],
      "id": "df6c3861-e403-4520-a873-52437aacccad",
      "name": "Notification Clinique",
      "webhookId": "3bef52f9-4716-4268-b878-bc223fe04930",
      "credentials": {
        "whatsAppApi": {
          "id": "XZeouCiwhxo4E8ue",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        208,
        96
      ],
      "id": "7f50be61-f686-4178-9bdb-fbe1aa82d1c3",
      "name": "Fusionner r√©sultats"
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "sabigonnaguian57@gmail.com",
          "mode": "list",
          "cachedResultName": "sabigonnaguian57@gmail.com"
        },
        "eventId": "={{ $json.event_id }}",
        "updateFields": {
          "description": "={{ $json.description + '\\n\\n‚úÖ Rappel envoy√©: ' + $now.toFormat('dd/MM/yyyy HH:mm') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        432,
        96
      ],
      "id": "fc1e0581-6244-4d10-886d-edd9d4902c6e",
      "name": "Marquer rappel envoy√©",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "I1W0uKaVADtsxitx",
          "name": "Google Calendar account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Extract Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Last 15 Messages": {
      "main": [
        [
          {
            "node": "Format History for AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Fields1": {
      "main": [
        [
          {
            "node": "Check Existing Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Existing Conversation1": {
      "main": [
        [
          {
            "node": "Is Existing Patient?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Existing Patient?1": {
      "main": [
        [
          {
            "node": "Merge Conversations1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create New Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Conversation1": {
      "main": [
        [
          {
            "node": "Merge Conversations1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Conversations1": {
      "main": [
        [
          {
            "node": "Normalize Conversation ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Conversation ID1": {
      "main": [
        [
          {
            "node": "Save User Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save User Message1": {
      "main": [
        [
          {
            "node": "Get Last 15 Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format History for AI1": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Send WhatsApp Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "FAQ Tool1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calendar Availability Tool1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calendar Create Event Tool1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Triage Creation Tool1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update Conversation Tool1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp Message1": {
      "main": [
        [
          {
            "node": "Save Assistant Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "V√©rifier toutes les 5min": {
      "main": [
        [
          {
            "node": "R√©cup√©rer RDV dans 25-35min",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "R√©cup√©rer RDV dans 25-35min": {
      "main": [
        [
          {
            "node": "Y a-t-il des RDV ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Y a-t-il des RDV ?": {
      "main": [
        [
          {
            "node": "Extraire donn√©es √©v√©nements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraire donn√©es √©v√©nements": {
      "main": [
        [
          {
            "node": "A un t√©l√©phone ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "A un t√©l√©phone ?": {
      "main": [
        [
          {
            "node": "Rappel WhatsApp Patient",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notification Clinique",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rappel WhatsApp Patient": {
      "main": [
        [
          {
            "node": "Fusionner r√©sultats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notification Clinique": {
      "main": [
        [
          {
            "node": "Fusionner r√©sultats",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fusionner r√©sultats": {
      "main": [
        [
          {
            "node": "Marquer rappel envoy√©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "fd9e1ce5-5845-4665-99b2-d7bf091005b4",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "204fbee7fba560a0ff0a7169dc0748a53baacdffc306f42aabf7e7f20725118e"
  },
  "id": "RSA9OVId8i8KtD1O",
  "tags": []
}
